<!DOCTYPE html>

<html>
<head>
  <title>helpers.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="apl.html">
                apl.coffee
              </a>
            
              
              <a class="source" href="command.html">
                command.coffee
              </a>
            
              
              <a class="source" href="compiler.html">
                compiler.coffee
              </a>
            
              
              <a class="source" href="complex.html">
                complex.coffee
              </a>
            
              
              <a class="source" href="formatter.html">
                formatter.coffee
              </a>
            
              
              <a class="source" href="helpers.html">
                helpers.coffee
              </a>
            
              
              <a class="source" href="lexer.html">
                lexer.coffee
              </a>
            
              
              <a class="source" href="parser.html">
                parser.coffee
              </a>
            
              
              <a class="source" href="vocabulary.html">
                vocabulary.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>helpers.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Prototypal inheritance of JavaScript objects
(see <a href="http://javascript.crockford.com/prototypal.html">Douglas Crockford&#39;s
explanation</a>)</p>
<p>This implementation allows extra properties to be assigned
to the newly-created object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="property">@inherit</span> = (x, extraProperties = {}) -&gt;
  f = (-&gt;); f:: = x; r = <span class="keyword">new</span> f
  <span class="keyword">for</span> k, v <span class="keyword">of</span> extraProperties <span class="keyword">then</span> r[k] = v
  r</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Helpers for the APL data model</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="property">@isSimple</span> = <span class="function"><span class="title">isSimple</span></span> = (x) -&gt; <span class="keyword">not</span> (x <span class="keyword">instanceof</span> Array)

<span class="property">@shapeOf</span> = <span class="function"><span class="title">shapeOf</span></span> = (a) -&gt;
  a.shape <span class="keyword">or</span>
    <span class="keyword">if</span> a.length? <span class="keyword">and</span> <span class="keyword">not</span> (<span class="keyword">typeof</span> a <span class="keyword">is</span> <span class="string">'string'</span> <span class="keyword">and</span> a.length <span class="keyword">is</span> <span class="number">1</span>)
      [a.length]
    <span class="keyword">else</span>
      []

<span class="property">@withShape</span> = <span class="function"><span class="title">withShape</span></span> = (shape, a) -&gt;
  assert (<span class="keyword">not</span> shape?) <span class="keyword">or</span> a.length <span class="keyword">is</span> prod shape
  <span class="keyword">if</span> shape? <span class="keyword">and</span> shape.length <span class="keyword">isnt</span> <span class="number">1</span> <span class="keyword">then</span> a.shape = shape
  a

<span class="property">@prototypeOf</span> = <span class="function"><span class="title">prototypeOf</span></span> = (x) -&gt;
  <span class="keyword">if</span> <span class="keyword">typeof</span> x <span class="keyword">is</span> <span class="string">'number'</span> <span class="keyword">then</span> <span class="number">0</span>
  <span class="keyword">else</span> <span class="keyword">if</span> <span class="keyword">typeof</span> x <span class="keyword">is</span> <span class="string">'string'</span> <span class="keyword">then</span> <span class="string">' '</span>
  <span class="keyword">else</span> <span class="keyword">if</span> x.aplPrototype? <span class="keyword">then</span> x.aplPrototype
  <span class="keyword">else</span> <span class="keyword">if</span> isSimple(x) <span class="keyword">or</span> <span class="keyword">not</span> x.length <span class="keyword">then</span> <span class="number">0</span>
  <span class="keyword">else</span> <span class="keyword">if</span> isSimple x[<span class="number">0</span>] <span class="keyword">then</span> prototypeOf x[<span class="number">0</span>]
  <span class="keyword">else</span>
    p = prototypeOf x[<span class="number">0</span>]
    withShape shapeOf(x[<span class="number">0</span>]), (<span class="keyword">for</span> [<span class="number">0.</span>..x[<span class="number">0</span>].length] <span class="keyword">then</span> p)

<span class="property">@withPrototype</span> = <span class="function"><span class="title">withPrototype</span></span> = (p, x) -&gt;
  <span class="keyword">if</span> (x <span class="keyword">instanceof</span> Array) <span class="keyword">and</span> (<span class="keyword">not</span> x.length) <span class="keyword">and</span> (p <span class="keyword">isnt</span> <span class="number">0</span>)
    x.aplPrototype = p
  x

<span class="property">@withPrototypeCopiedFrom</span> = (y, x) -&gt;
  <span class="keyword">if</span> x <span class="keyword">instanceof</span> Array <span class="keyword">and</span> <span class="keyword">not</span> x.length
    withPrototype prototypeOf(y), x
  x</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Sum and product;  I wish JavaScript had a <em>reduce</em> operator :)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="property">@sum</span> = (xs) -&gt; r = <span class="number">0</span>; (<span class="keyword">for</span> x <span class="keyword">in</span> xs <span class="keyword">then</span> r += x); r
<span class="property">@prod</span> = <span class="function"><span class="title">prod</span></span> = (xs) -&gt; r = <span class="number">1</span>; (<span class="keyword">for</span> x <span class="keyword">in</span> xs <span class="keyword">then</span> r *= x); r
<span class="property">@all</span> = (xs) -&gt; (<span class="keyword">for</span> x <span class="keyword">in</span> xs <span class="keyword">when</span> <span class="keyword">not</span> x <span class="keyword">then</span> <span class="keyword">return</span> <span class="literal">false</span>); <span class="literal">true</span>

<span class="property">@enc</span> = (x, a) -&gt;
  r = []
  <span class="keyword">for</span> i <span class="keyword">in</span> [a.length - <span class="number">1</span> .. <span class="number">0</span>] <span class="keyword">by</span> -<span class="number">1</span>
    r.push x % a[i]
    x = Math.floor x / a[i]
  r.reverse()

<span class="property">@dec</span> = (xs, a) -&gt;
  assert xs.length <span class="keyword">is</span> a.length
  r = <span class="number">0</span>
  <span class="keyword">for</span> x, i <span class="keyword">in</span> xs <span class="keyword">then</span> r = r * a[i] + x
  r</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p><code>repeat(s, n)</code> catenates <code>n</code> instances of a string <code>s</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="property">@repeat</span> = <span class="function"><span class="title">repeat</span></span> = (s, n) -&gt; r = <span class="string">''</span>; (<span class="keyword">for</span> [<span class="number">0.</span>..n] <span class="keyword">then</span> r += s); r

<span class="property">@assert</span> = <span class="function"><span class="title">assert</span></span> = (flag, s = <span class="string">'Assertion failed'</span>) -&gt;
  <span class="keyword">if</span> <span class="keyword">not</span> flag <span class="keyword">then</span> <span class="keyword">throw</span> Error s

<span class="property">@die</span> = (message, opts = {}, args...) -&gt;
  assert <span class="keyword">typeof</span> message <span class="keyword">is</span> <span class="string">'string'</span>
  assert <span class="keyword">typeof</span> opts <span class="keyword">is</span> <span class="string">'object'</span>
  assert <span class="keyword">not</span> args.length
  <span class="keyword">if</span> opts.aplCode? <span class="keyword">and</span> opts.line? <span class="keyword">and</span> opts.col?
    assert <span class="keyword">typeof</span> opts.aplCode <span class="keyword">is</span> <span class="string">'string'</span>
    assert <span class="keyword">typeof</span> opts.line <span class="keyword">is</span> <span class="string">'number'</span>
    assert <span class="keyword">typeof</span> opts.col <span class="keyword">is</span> <span class="string">'number'</span>
    assert <span class="keyword">typeof</span> opts.file <span class="keyword">in</span> [<span class="string">'string'</span>, <span class="string">'undefined'</span>]
    message += <span class="string">"""
      \n<span class="subst">#{opts.file <span class="keyword">or</span> '-'}</span>:#<span class="subst">#{opts.line}</span>:<span class="subst">#{opts.col}</span>
      <span class="subst">#{opts.aplCode.split('\n')[opts.line - <span class="number">1</span>]}</span>
      <span class="subst">#{repeat('_', opts.col - <span class="number">1</span>)}</span>^
    """</span>
  e = Error message
  <span class="keyword">for</span> k, v <span class="keyword">of</span> opts
    assert k <span class="keyword">in</span> [<span class="string">'aplCode'</span>, <span class="string">'line'</span>, <span class="string">'col'</span>, <span class="string">'file'</span>, <span class="string">'name'</span>]
    e[k] = v
  <span class="keyword">throw</span> e</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
