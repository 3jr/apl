<!DOCTYPE html>  <html> <head>   <title>helpers.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="browser.html">                 browser.coffee               </a>                                           <a class="source" href="builtins.html">                 builtins.coffee               </a>                                           <a class="source" href="command.html">                 command.coffee               </a>                                           <a class="source" href="grammar.html">                 grammar.coffee               </a>                                           <a class="source" href="helpers.html">                 helpers.coffee               </a>                                           <a class="source" href="interpreter.html">                 interpreter.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               helpers.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Prototypal inheritance of JavaScript objects
(see <a href="http://javascript.crockford.com/prototypal.html">Douglas Crockford's explanation</a>)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">inherit</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nx">f</span> <span class="o">=</span> <span class="p">(</span><span class="o">-&gt;</span><span class="p">);</span> <span class="nx">f</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span> <span class="k">new</span> <span class="nx">f</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>A continuation-passing style helper that works around the lack of tail call optimisation
(see <a href="https://secure.wikimedia.org/wikipedia/en/wiki/Continuation-passing_style#Use_and_implementation">Wikipedia</a>)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">trampoline</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">while</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span> <span class="k">then</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span><span class="p">()</span>
  <span class="nx">x</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p><code>cps(f)</code> marks a function <code>f</code> as following the CPS calling convention</p>

<p>This means that <code>f</code> accepts a callback as its fourth argument (the first
three being allotted for APL left argument, right argument, and axis
specification).  The callback should be invoked later either with its first
argument set to an Error object, or with its second argument set to the
result.</p>

<p>The CPS function may (directly) return either undefined, or another
function which should be executed immediately after it.  (This process will
be controlled by a trampoline() at a higher level in the code.)</p>

<p>An example of a traditional function</p>

<pre><code>     (a, b, c) -&gt; a * b + c
</code></pre>

<p>turned into CPS (and marked as CPS) is:</p>

<pre><code>     cps (a, b, c, callback) -&gt; -&gt; callback null, a * b + c
</code></pre>

<p>A function is marked as CPS by setting its ".cps" property to true.
That informs callers that they should follow the CPS convention, too.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">cps</span> <span class="o">=</span> <span class="nx">cps</span> <span class="o">=</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nx">f</span><span class="p">.</span><span class="nx">cps</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="nx">f</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p><code>cpsify(f)</code> decorates a traditional function so that it follows the CPS
calling convention.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">cpsify</span> <span class="o">=</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">if</span> <span class="nx">f</span><span class="p">.</span><span class="nx">cps</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">f</span>
  <span class="nx">cps</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">try</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="nx">f</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span>
      <span class="o">-&gt;</span> <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">result</span>
    <span class="k">catch</span> <span class="nx">err</span>
      <span class="o">-&gt;</span> <span class="nx">callback</span> <span class="nx">err</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Helpers for the APL data model</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">isSimple</span> <span class="o">=</span> <span class="nx">isSimple</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">is</span> <span class="s1">&#39;number&#39;</span> <span class="o">or</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">shapeOf</span> <span class="o">=</span> <span class="nx">shapeOf</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">shape</span> <span class="o">or</span> <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="o">?</span> <span class="k">then</span> <span class="p">[</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">else</span> <span class="p">[]</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">withShape</span> <span class="o">=</span> <span class="nx">withShape</span> <span class="o">=</span> <span class="p">(</span><span class="nx">shape</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="k">if</span> <span class="nx">shape</span><span class="o">?</span> <span class="o">and</span> <span class="nx">shape</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="mi">1</span> <span class="k">then</span> <span class="nx">a</span><span class="p">.</span><span class="nx">shape</span> <span class="o">=</span> <span class="nx">shape</span><span class="p">);</span> <span class="nx">a</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">prototypeOf</span> <span class="o">=</span> <span class="nx">prototypeOf</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">is</span> <span class="s1">&#39;number&#39;</span> <span class="k">then</span> <span class="mi">0</span>
  <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span> <span class="k">then</span> <span class="s1">&#39; &#39;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="nx">x</span><span class="p">.</span><span class="nx">aplPrototype</span><span class="o">?</span> <span class="k">then</span> <span class="nx">x</span><span class="p">.</span><span class="nx">aplPrototype</span>
  <span class="k">else</span> <span class="k">if</span> <span class="nx">isSimple</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="mi">0</span>
  <span class="k">else</span> <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">then</span> <span class="nx">prototypeOf</span> <span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">else</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">prototypeOf</span> <span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="nx">withShape</span> <span class="nx">shapeOf</span><span class="p">(</span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="k">for</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="nx">p</span><span class="p">)</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">withPrototype</span> <span class="o">=</span> <span class="nx">withPrototype</span> <span class="o">=</span> <span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="o">not</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="nx">p</span> <span class="o">isnt</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span> <span class="nx">x</span><span class="p">.</span><span class="nx">aplPrototype</span> <span class="o">=</span> <span class="nx">p</span>
  <span class="nx">x</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">withPrototypeCopiedFrom</span> <span class="o">=</span> <span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="o">not</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">then</span> <span class="nx">withPrototype</span> <span class="nx">prototypeOf</span><span class="p">(</span><span class="nx">y</span><span class="p">),</span> <span class="nx">x</span>
  <span class="nx">x</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Sum and product;  I wish JavaScript had a <em>reduce</em> operator :)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">sum</span> <span class="o">=</span> <span class="p">(</span><span class="nx">xs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">xs</span> <span class="k">then</span> <span class="nx">r</span> <span class="o">+=</span> <span class="nx">x</span><span class="p">);</span> <span class="nx">r</span>
<span class="nx">exports</span><span class="p">.</span><span class="nx">prod</span> <span class="o">=</span> <span class="p">(</span><span class="nx">xs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">xs</span> <span class="k">then</span> <span class="nx">r</span> <span class="o">*=</span> <span class="nx">x</span><span class="p">);</span> <span class="nx">r</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p><code>repeat(s, n)</code> catenates <code>n</code> instances of a string <code>s</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">repeat</span> <span class="o">=</span> <span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">r</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="p">(</span><span class="k">for</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">n</span><span class="p">]</span> <span class="k">then</span> <span class="nx">r</span> <span class="o">+=</span> <span class="nx">s</span><span class="p">);</span> <span class="nx">r</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 