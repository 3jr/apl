<!DOCTYPE html>  <html> <head>   <title>builtins.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="browser.html">                 browser.coffee               </a>                                           <a class="source" href="builtins.html">                 builtins.coffee               </a>                                           <a class="source" href="command.html">                 command.coffee               </a>                                           <a class="source" href="helpers.html">                 helpers.coffee               </a>                                           <a class="source" href="interpreter.html">                 interpreter.coffee               </a>                                           <a class="source" href="parser.html">                 parser.jison               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               builtins.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="c1">#!/usr/bin/env coffee</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>This file contains an implementation of APL's built-in functions and
operators.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h1>A note about the data model</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>APL's data structures are multidimensional arrays:</p>

<ul>
<li><p>(rank 0) Scalars---can be:</p>

<ul><li><p>simple scalars, like numbers and characters</p></li>
<li><p>an APL array of rank zero, containing exactly one element</p></li></ul></li>
<li><p>(rank 1) Vectors---sequences of APL objects with zero or more elements</p></li>
<li><p>(rank 2) Matrices---two-dimensional arrays of APL objects</p></li>
<li><p>(rank 3+) Cubes, etc</p></li>
</ul>

<p>APL arrays are not necessarily heterogenous, they may contain data of mixed
types.</p>

<p>An array in APL is aware of its own dimensions, so there is an essential
difference between a vector of vectors and a matrix.  To reflect this in
JavaScript objects, we use the following convention:</p>

<ul>
<li><p>APL scalars:</p>

<ul><li><p>Simple scalars: APL numbers are JavaScript numbers and APL characters
are JavaScript one-character strings.</p></li>
<li><p>A zero-rank APL array is a JavaScript array of size one with a
<code>shape</code> property of <code>[]</code>, e.g. created by:</p>

<pre><code>  var a = []; a.shape = [];
</code></pre></li></ul></li>
<li><p>An APL vector is a JavaScript array.</p></li>
<li><p>An APL matrix, cube, etc is a JavaScript array with an additional <code>shape</code>
property, describing the dimensions of the APL array.  E.g. a 2-by-2-by-3
cube of zeroes may be constructed via:</p>

<pre><code>  function createSomeCube() {
      var cube = [
          0, // Element at indices [0;0;0]
          0, // Element at indices [0;0;1]
          0, // Element at indices [0;0;2]
          0, // Element at indices [0;1;0]
          0, // Element at indices [0;1;1]
          // ...
          0  // Element at indices [1;1;2]
      ];
      cube.shape = [2, 2, 3];
      return cube;
  }
</code></pre>

<p>A vector's representation, as opposed to that of higher-dimension
  arrays, is not required to have a <code>shape</code> property.  The shape of a
  vector <code>v</code> is assumed to be <code>[v.length]</code>, by convention.  Similarly, we
  could say that a scalar's shape is <code>[]</code> by convention.</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>TODO: Can we model APL's concept of "prototypes"?</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h1>Utility functions</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">cps</span><span class="p">,</span> <span class="nx">cpsify</span><span class="p">,</span> <span class="nx">isSimple</span><span class="p">,</span> <span class="nx">shapeOf</span><span class="p">,</span> <span class="nx">sum</span><span class="p">,</span> <span class="nx">prod</span><span class="p">,</span> <span class="nx">repeat</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;./helpers&#39;</span>
<span class="nx">withShape</span> <span class="o">=</span> <span class="p">(</span><span class="nx">shape</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="k">if</span> <span class="nx">shape</span><span class="o">?</span> <span class="o">and</span> <span class="nx">shape</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="mi">1</span> <span class="k">then</span> <span class="nx">a</span><span class="p">.</span><span class="nx">shape</span> <span class="o">=</span> <span class="nx">shape</span><span class="p">);</span> <span class="nx">a</span>
<span class="nx">arrayValueOf</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">x</span> <span class="k">then</span> <span class="p">[</span><span class="nx">x</span><span class="p">]</span> <span class="k">else</span> <span class="nx">x</span>

<span class="nx">numericValueOf</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="k">if</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span><span class="o">?</span>
    <span class="k">if</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Numeric scalar or singleton expected&#39;</span>
    <span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">isnt</span> <span class="s1">&#39;number&#39;</span> <span class="k">then</span> <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Numeric scalar or singleton expected&#39;</span>
  <span class="nx">x</span>

<span class="nx">booleanValueOf</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nx">x</span> <span class="o">=</span> <span class="nx">numericValueOf</span> <span class="nx">x</span>
  <span class="k">if</span> <span class="nx">x</span> <span class="o">isnt</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">x</span> <span class="o">isnt</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Boolean values must be either 0 or 1&#39;</span>
  <span class="nx">x</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p><code>pervasive(f)</code> is a dcorator which takes a scalar function <code>f</code> and makes it
propagate through arrays.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">pervasive</span> <span class="o">=</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nx">F</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">callee</span>
  <span class="k">if</span> <span class="nx">b</span><span class="o">?</span> <span class="c1"># dyadic pervasiveness</span>
    <span class="k">if</span> <span class="nx">isSimple</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">and</span> <span class="nx">isSimple</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="k">then</span> <span class="nx">f</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="nx">withShape</span> <span class="nx">b</span><span class="p">.</span><span class="nx">shape</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">b</span> <span class="k">then</span> <span class="nx">F</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">b</span> <span class="k">then</span> <span class="nx">withShape</span> <span class="nx">a</span><span class="p">.</span><span class="nx">shape</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">then</span> <span class="nx">F</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">sa</span> <span class="o">=</span> <span class="nx">shapeOf</span> <span class="nx">a</span><span class="p">;</span> <span class="nx">sb</span> <span class="o">=</span> <span class="nx">shapeOf</span> <span class="nx">b</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">sa</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">isnt</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="k">then</span> <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Length error&#39;</span>
      <span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span>
        <span class="nx">k</span> <span class="o">=</span> <span class="nx">prod</span> <span class="nx">sa</span><span class="p">[</span><span class="nx">sb</span><span class="p">.</span><span class="nx">length</span><span class="p">...]</span>
        <span class="nx">withShape</span> <span class="nx">sa</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="nx">F</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">i</span> <span class="o">/</span> <span class="nx">k</span><span class="p">])</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span>
        <span class="nx">k</span> <span class="o">=</span> <span class="nx">prod</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">sa</span><span class="p">.</span><span class="nx">length</span><span class="p">...]</span>
        <span class="nx">withShape</span> <span class="nx">sb</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="nx">F</span> <span class="nx">a</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">i</span> <span class="o">/</span> <span class="nx">k</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
      <span class="k">else</span>
        <span class="nx">withShape</span> <span class="nx">sa</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="nx">F</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
  <span class="k">else</span> <span class="c1"># monadic pervasiveness</span>
    <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="nx">f</span> <span class="nx">a</span>
    <span class="k">else</span> <span class="nx">withShape</span> <span class="nx">a</span><span class="p">.</span><span class="nx">shape</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">then</span> <span class="nx">F</span> <span class="nx">x</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h1>DSL for defining operators and functions</h1>

<p><code>builtins</code> will be the prototype of all execution contexts, see <a href="interpreter.html">interpreter.coffee</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">exports</span><span class="p">.</span><span class="nx">builtins</span> <span class="o">=</span> <span class="nx">builtins</span> <span class="o">=</span> <span class="p">{}</span>

<span class="nx">prefixOperator</span>  <span class="o">=</span> <span class="p">(</span><span class="nx">symbol</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">isPrefixOperator</span>  <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">aplName</span> <span class="o">=</span> <span class="nx">symbol</span><span class="p">;</span> <span class="nx">builtins</span><span class="p">[</span><span class="nx">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="nx">f</span>
<span class="nx">postfixOperator</span> <span class="o">=</span> <span class="p">(</span><span class="nx">symbol</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">isPostfixOperator</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">aplName</span> <span class="o">=</span> <span class="nx">symbol</span><span class="p">;</span> <span class="nx">builtins</span><span class="p">[</span><span class="nx">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="nx">f</span>
<span class="nx">infixOperator</span>   <span class="o">=</span> <span class="p">(</span><span class="nx">symbol</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">isInfixOperator</span>   <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">aplName</span> <span class="o">=</span> <span class="nx">symbol</span><span class="p">;</span> <span class="nx">builtins</span><span class="p">[</span><span class="nx">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="nx">f</span>

<span class="nx">ambivalent</span> <span class="o">=</span> <span class="p">(</span><span class="nx">f1</span><span class="p">,</span> <span class="nx">f2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># combine a monadic and a dyadic function into one</span>
  <span class="nx">f</span> <span class="o">=</span> <span class="p">(</span><span class="nx">args</span><span class="p">...)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="k">if</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">?</span> <span class="k">then</span> <span class="nx">f2</span> <span class="k">else</span> <span class="nx">f1</span><span class="p">)(</span><span class="nx">args</span><span class="p">...)</span>
  <span class="nx">f</span><span class="p">.</span><span class="nx">aplName</span> <span class="o">=</span> <span class="nx">f1</span><span class="p">.</span><span class="nx">aplName</span> <span class="o">or</span> <span class="nx">f2</span><span class="p">.</span><span class="nx">aplName</span>
  <span class="nx">f</span>

<span class="nx">monadic</span> <span class="o">=</span> <span class="p">(</span><span class="nx">symbol</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nx">f</span> <span class="o">?=</span> <span class="o">-&gt;</span> <span class="k">throw</span> <span class="nb">Error</span> <span class="s2">&quot;Monadic function #{symbol} is not available.&quot;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">g</span> <span class="o">=</span> <span class="nx">builtins</span><span class="p">[</span><span class="nx">symbol</span><span class="p">])</span> <span class="k">then</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">ambivalent</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">g</span>
  <span class="nx">f</span><span class="p">.</span><span class="nx">aplName</span> <span class="o">=</span> <span class="nx">symbol</span>
  <span class="nx">builtins</span><span class="p">[</span><span class="nx">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="nx">f</span>

<span class="nx">dyadic</span> <span class="o">=</span> <span class="p">(</span><span class="nx">symbol</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nx">f</span> <span class="o">?=</span> <span class="o">-&gt;</span> <span class="k">throw</span> <span class="nb">Error</span> <span class="s2">&quot;Dyadic function #{symbol} is not available.&quot;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">g</span> <span class="o">=</span> <span class="nx">builtins</span><span class="p">[</span><span class="nx">symbol</span><span class="p">])</span> <span class="k">then</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">ambivalent</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">f</span>
  <span class="nx">f</span><span class="p">.</span><span class="nx">aplName</span> <span class="o">=</span> <span class="nx">symbol</span>
  <span class="nx">builtins</span><span class="p">[</span><span class="nx">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="nx">f</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h1>Built-in functions</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">monadic</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">a</span>                              <span class="c1"># Conjugate</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span>             <span class="c1"># Add</span>
<span class="nx">monadic</span> <span class="s1">&#39;−&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span>    <span class="o">-&gt;</span> <span class="o">-</span><span class="nx">x</span>                <span class="c1"># Negate</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;−&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">x</span> <span class="o">-</span> <span class="nx">y</span>             <span class="c1"># Subtract</span>
<span class="nx">monadic</span> <span class="s1">&#39;×&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span>    <span class="o">-&gt;</span> <span class="k">if</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span> <span class="c1"># Sign of</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;×&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">y</span>             <span class="c1"># Multiply</span>
<span class="nx">monadic</span> <span class="s1">&#39;÷&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span>    <span class="o">-&gt;</span> <span class="mi">1</span> <span class="o">/</span> <span class="nx">x</span>             <span class="c1"># Reciprocal</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;÷&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">x</span> <span class="o">/</span> <span class="nx">y</span>             <span class="c1"># Divide</span>
<span class="nx">monadic</span> <span class="s1">&#39;⌈&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span>    <span class="o">-&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span> <span class="nx">x</span>       <span class="c1"># Ceiling</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;⌈&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span>     <span class="c1"># Greater of</span>
<span class="nx">monadic</span> <span class="s1">&#39;⌊&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span>    <span class="o">-&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">x</span>      <span class="c1"># Math.Floor</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;⌊&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span>     <span class="c1"># Lesser of</span>
<span class="nx">monadic</span> <span class="s1">&#39;∣&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span>    <span class="o">-&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span> <span class="nx">x</span>        <span class="c1"># Absolute value</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;∣&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">y</span> <span class="o">%</span> <span class="nx">x</span>             <span class="c1"># Residue</span>
<span class="nx">monadic</span> <span class="s1">&#39;⍳&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">numericValueOf</span> <span class="nx">a</span><span class="p">]</span> <span class="c1"># Index generate</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;⍳&#39;</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Not implemented&#39;</span>      <span class="c1"># Index of</span>
<span class="nx">monadic</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">numericValueOf</span> <span class="nx">x</span> <span class="c1"># Roll</span>

<span class="nx">dyadic</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Deal</span>
  <span class="nx">x</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">numericValueOf</span> <span class="nx">x</span>
  <span class="nx">y</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">numericValueOf</span> <span class="nx">y</span>
  <span class="k">if</span> <span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">y</span> <span class="k">then</span> <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Domain error: left argument of ? must not be greater than its right argument.&#39;</span>
  <span class="nx">available</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">y</span><span class="p">]</span>
  <span class="k">for</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">x</span><span class="p">]</span> <span class="k">then</span> <span class="nx">available</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">available</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="nx">monadic</span> <span class="s1">&#39;⋆&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span> <span class="nx">numericValueOf</span> <span class="nx">x</span> <span class="c1"># Exponentiate</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;⋆&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span> <span class="nx">numericValueOf</span><span class="p">(</span><span class="nx">x</span><span class="p">),</span> <span class="nx">numericValueOf</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="c1"># To the power of</span>
<span class="nx">monadic</span> <span class="s1">&#39;⍟&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">log</span> <span class="nx">x</span> <span class="c1"># Natural logarithm</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;⍟&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="c1"># Logarithm to the base</span>
<span class="nx">monadic</span> <span class="s1">&#39;○&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="nx">x</span> <span class="c1"># Math.Pi times</span>

<span class="nx">dyadic</span> <span class="s1">&#39;○&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Circular and hyperbolic functions</span>
  <span class="k">switch</span> <span class="nx">i</span>
    <span class="k">when</span> <span class="mi">0</span> <span class="k">then</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">)</span>
    <span class="k">when</span> <span class="mi">1</span> <span class="k">then</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span> <span class="nx">x</span>
    <span class="k">when</span> <span class="mi">2</span> <span class="k">then</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span> <span class="nx">x</span>
    <span class="k">when</span> <span class="mi">3</span> <span class="k">then</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">tan</span> <span class="nx">x</span>
    <span class="k">when</span> <span class="mi">4</span> <span class="k">then</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">)</span>
    <span class="k">when</span> <span class="mi">5</span> <span class="k">then</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="c1"># sinh</span>
    <span class="k">when</span> <span class="mi">6</span> <span class="k">then</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="c1"># cosh</span>
    <span class="k">when</span> <span class="mi">7</span> <span class="k">then</span> <span class="nx">ex</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">x</span><span class="p">);</span> <span class="p">(</span><span class="nx">ex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">ex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># tanh</span>
    <span class="k">when</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">asin</span> <span class="nx">x</span>
    <span class="k">when</span> <span class="o">-</span><span class="mi">2</span> <span class="k">then</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">acos</span> <span class="nx">x</span>
    <span class="k">when</span> <span class="o">-</span><span class="mi">3</span> <span class="k">then</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan</span> <span class="nx">x</span>
    <span class="k">when</span> <span class="o">-</span><span class="mi">4</span> <span class="k">then</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">when</span> <span class="o">-</span><span class="mi">5</span> <span class="k">then</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="c1"># arcsinh</span>
    <span class="k">when</span> <span class="o">-</span><span class="mi">6</span> <span class="k">then</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="c1"># arccosh</span>
    <span class="k">when</span> <span class="o">-</span><span class="mi">7</span> <span class="k">then</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="nx">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">x</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="c1"># arctanh</span>
    <span class="k">else</span> <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Unknown circular or hyperbolic function &#39;</span> <span class="o">+</span> <span class="nx">i</span>

<span class="nx">monadic</span> <span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Factorial</span>
  <span class="nx">n</span> <span class="o">=</span> <span class="nx">a</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">numericValueOf</span> <span class="nx">a</span> <span class="c1"># todo: &quot;Gamma&quot; function for non-integer argument</span>
  <span class="nx">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="k">if</span> <span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">2</span> <span class="p">..</span> <span class="nx">n</span><span class="p">]</span> <span class="k">then</span> <span class="nx">r</span> <span class="o">*=</span> <span class="nx">i</span><span class="p">);</span> <span class="nx">r</span>

<span class="nx">dyadic</span> <span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Binomial</span>
  <span class="nx">k</span> <span class="o">=</span> <span class="nx">a</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">numericValueOf</span> <span class="nx">a</span>
  <span class="nx">n</span> <span class="o">=</span> <span class="nx">b</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">numericValueOf</span> <span class="nx">b</span>
  <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">k</span> <span class="o">&lt;=</span> <span class="nx">n</span><span class="p">)</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span> <span class="c1"># todo: Special cases for negatives and non-integers</span>
  <span class="k">if</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">k</span> <span class="o">&gt;</span> <span class="nx">n</span> <span class="k">then</span> <span class="nx">k</span> <span class="o">=</span> <span class="nx">n</span> <span class="o">-</span> <span class="nx">k</span> <span class="c1"># do less work</span>
  <span class="nx">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="k">if</span> <span class="nx">k</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span> <span class="p">..</span> <span class="nx">k</span><span class="p">]</span> <span class="k">then</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">r</span> <span class="o">*</span> <span class="p">(</span><span class="nx">n</span> <span class="o">-</span> <span class="nx">k</span> <span class="o">+</span> <span class="nx">i</span><span class="p">)</span> <span class="o">/</span> <span class="nx">i</span><span class="p">);</span> <span class="nx">r</span>

<span class="nx">monadic</span> <span class="s1">&#39;⌹&#39;</span> <span class="c1"># Matrix inverse</span>
<span class="nx">dyadic</span> <span class="s1">&#39;⌹&#39;</span> <span class="c1"># Matrix divide</span>
<span class="nx">dyadic</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">+</span><span class="p">(</span><span class="nx">x</span> <span class="o">&lt;</span>    <span class="nx">y</span><span class="p">)</span> <span class="c1"># Less than</span>
<span class="nx">dyadic</span> <span class="s1">&#39;≤&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">+</span><span class="p">(</span><span class="nx">x</span> <span class="o">&lt;=</span>   <span class="nx">y</span><span class="p">)</span> <span class="c1"># Less than or equal</span>
<span class="nx">dyadic</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">+</span><span class="p">(</span><span class="nx">x</span> <span class="o">is</span>   <span class="nx">y</span><span class="p">)</span> <span class="c1"># Equal</span>
<span class="nx">dyadic</span> <span class="s1">&#39;≥&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">+</span><span class="p">(</span><span class="nx">x</span> <span class="o">&gt;=</span>   <span class="nx">y</span><span class="p">)</span> <span class="c1"># Greater than</span>
<span class="nx">dyadic</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">+</span><span class="p">(</span><span class="nx">x</span> <span class="o">&gt;</span>    <span class="nx">y</span><span class="p">)</span> <span class="c1"># Greater than or equal</span>
<span class="nx">dyadic</span> <span class="s1">&#39;≠&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">+</span><span class="p">(</span><span class="nx">x</span> <span class="o">isnt</span> <span class="nx">y</span><span class="p">)</span> <span class="c1"># Not equal</span>

<span class="nx">monadic</span> <span class="s1">&#39;≡&#39;</span><span class="p">,</span> <span class="nx">depthOf</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Depth</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span>
  <span class="nx">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">then</span> <span class="nx">r</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">depthOf</span> <span class="nx">x</span><span class="p">);</span> <span class="nx">r</span> <span class="o">+</span> <span class="mi">1</span>

<span class="nx">dyadic</span> <span class="s1">&#39;≡&#39;</span><span class="p">,</span> <span class="nx">match</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Match</span>
  <span class="k">if</span> <span class="nx">isSimple</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">and</span> <span class="nx">isSimple</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="k">then</span> <span class="k">return</span> <span class="o">+</span><span class="p">(</span><span class="nx">a</span> <span class="o">is</span> <span class="nx">b</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">isSimple</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">isnt</span> <span class="nx">isSimple</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span>
  <span class="nx">sa</span> <span class="o">=</span> <span class="nx">shapeOf</span> <span class="nx">a</span>
  <span class="nx">sb</span> <span class="o">=</span> <span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">sa</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">when</span> <span class="nx">sa</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">isnt</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span>
  <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">match</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span>
  <span class="mi">1</span>

<span class="nx">dyadic</span> <span class="s1">&#39;≢&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">+not</span> <span class="nx">match</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="c1"># Not match</span>

<span class="nx">monadic</span> <span class="s1">&#39;∈&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Enlist</span>
  <span class="nx">r</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nx">rec</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">x</span> <span class="k">then</span> <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">x</span> <span class="k">else</span> <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="nx">x</span> <span class="k">then</span> <span class="nx">rec</span> <span class="nx">y</span><span class="p">);</span> <span class="nx">r</span>
  <span class="nx">rec</span> <span class="nx">a</span>

<span class="nx">dyadic</span> <span class="s1">&#39;∈&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Membership</span>
  <span class="nx">a</span> <span class="o">=</span> <span class="nx">arrayValueOf</span> <span class="nx">a</span>
  <span class="nx">b</span> <span class="o">=</span> <span class="nx">arrayValueOf</span> <span class="nx">b</span>
  <span class="nx">withShape</span> <span class="nx">a</span><span class="p">.</span><span class="nx">shape</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">then</span> <span class="o">+</span><span class="p">(</span><span class="nx">x</span> <span class="k">in</span> <span class="nx">b</span><span class="p">))</span>

<span class="nx">dyadic</span>  <span class="s1">&#39;⍷&#39;</span> <span class="c1"># Find</span>
<span class="nx">monadic</span> <span class="s1">&#39;∪&#39;</span> <span class="c1"># Unique</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;∪&#39;</span> <span class="c1"># Union</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;∩&#39;</span> <span class="c1"># Intersection</span>
<span class="nx">monadic</span> <span class="s1">&#39;∼&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">+!</span><span class="nx">booleanValueOf</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="c1"># Not</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;∼&#39;</span> <span class="c1"># Without</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;∨&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">booleanValueOf</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">||</span> <span class="nx">booleanValueOf</span><span class="p">(</span><span class="nx">y</span><span class="p">))</span> <span class="c1"># Or</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;∧&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">booleanValueOf</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">booleanValueOf</span><span class="p">(</span><span class="nx">y</span><span class="p">))</span> <span class="c1"># And</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;⍱&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">+!</span><span class="p">(</span><span class="nx">booleanValueOf</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">||</span> <span class="nx">booleanValueOf</span><span class="p">(</span><span class="nx">y</span><span class="p">))</span> <span class="c1"># Nor</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;⍲&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="o">+!</span><span class="p">(</span><span class="nx">booleanValueOf</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">booleanValueOf</span><span class="p">(</span><span class="nx">y</span><span class="p">))</span> <span class="c1"># Nand</span>
<span class="nx">monadic</span> <span class="s1">&#39;⍴&#39;</span><span class="p">,</span> <span class="nx">shapeOf</span> <span class="c1"># Shape of</span>

<span class="nx">dyadic</span> <span class="s1">&#39;⍴&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Reshape</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[</span><span class="nx">a</span><span class="p">]</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">b</span> <span class="k">then</span> <span class="nx">b</span> <span class="o">=</span> <span class="p">[</span><span class="nx">b</span><span class="p">]</span>
  <span class="nx">a</span> <span class="o">=</span>
    <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span>
      <span class="k">if</span> <span class="o">not</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">is</span> <span class="s1">&#39;number&#39;</span>
        <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Domain error: Left argument to ⍴ must be a numeric scalar or vector.&#39;</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">x</span>
  <span class="nx">withShape</span> <span class="nx">a</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">prod</span> <span class="nx">a</span><span class="p">]</span> <span class="k">then</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span> <span class="o">%</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">])</span>

<span class="nx">monadic</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">arrayValueOf</span><span class="p">(</span><span class="nx">a</span><span class="p">)[</span><span class="mi">0</span><span class="p">...]</span> <span class="c1"># Ravel</span>

<span class="nx">catenate</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># helper for functions , and ⍪</span>
  <span class="nx">sa</span> <span class="o">=</span> <span class="nx">shapeOf</span> <span class="nx">a</span><span class="p">;</span> <span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">sa</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[</span><span class="nx">a</span><span class="p">]</span>
  <span class="nx">sb</span> <span class="o">=</span> <span class="nx">shapeOf</span> <span class="nx">b</span><span class="p">;</span> <span class="k">if</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">sb</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="nx">b</span> <span class="o">=</span> <span class="p">[</span><span class="nx">b</span><span class="p">]</span>
  <span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Length error: Cannot catenate arrays of different ranks&#39;</span>
  <span class="k">if</span> <span class="nx">axis</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">axis</span> <span class="o">+=</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">sa</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">when</span> <span class="nx">sa</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">isnt</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">and</span> <span class="nx">i</span> <span class="o">isnt</span> <span class="nx">axis</span>
    <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Length error: Catenated arrays must match at all axes exept the one to catenate on&#39;</span>
  <span class="nx">ni</span> <span class="o">=</span> <span class="nx">prod</span> <span class="nx">sa</span><span class="p">[...</span><span class="nx">axis</span><span class="p">]</span>       <span class="c1"># number of items across all dimensions before `axis&#39;</span>
  <span class="nx">nja</span> <span class="o">=</span> <span class="nx">sa</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span>              <span class="c1"># number of items across `axis&#39; in `a&#39;</span>
  <span class="nx">njb</span> <span class="o">=</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span>              <span class="c1"># number of items across `axis&#39; in `b&#39;</span>
  <span class="nx">nk</span> <span class="o">=</span> <span class="nx">prod</span> <span class="nx">sa</span><span class="p">[</span><span class="nx">axis</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">...]</span>  <span class="c1"># number of items across all dimensions after `axis&#39;</span>
  <span class="nx">r</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">ni</span><span class="p">]</span>
    <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">nja</span><span class="p">]</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">nk</span><span class="p">]</span> <span class="k">then</span> <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">a</span><span class="p">[</span><span class="nx">k</span> <span class="o">+</span> <span class="nx">nk</span> <span class="o">*</span> <span class="p">(</span><span class="nx">j</span> <span class="o">+</span> <span class="nx">nja</span> <span class="o">*</span> <span class="nx">i</span><span class="p">)]</span>
    <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">njb</span><span class="p">]</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">nk</span><span class="p">]</span> <span class="k">then</span> <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">b</span><span class="p">[</span><span class="nx">k</span> <span class="o">+</span> <span class="nx">nk</span> <span class="o">*</span> <span class="p">(</span><span class="nx">j</span> <span class="o">+</span> <span class="nx">njb</span> <span class="o">*</span> <span class="nx">i</span><span class="p">)]</span>
  <span class="nx">sr</span> <span class="o">=</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">sa</span> <span class="k">then</span> <span class="nx">x</span>
  <span class="nx">sr</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span>
  <span class="nx">withShape</span> <span class="nx">sr</span><span class="p">,</span> <span class="nx">r</span>

<span class="nx">dyadic</span>  <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nx">catenate</span> <span class="c1"># Catenate</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;⍪&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">catenate</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="mi">0</span> <span class="c1"># 1st axis catenate</span>

<span class="nx">monadic</span> <span class="s1">&#39;⌽&#39;</span><span class="p">,</span> <span class="nx">reverse</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Reverse</span>
  <span class="nx">sa</span> <span class="o">=</span> <span class="nx">shapeOf</span> <span class="nx">a</span>
  <span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">a</span>
  <span class="k">if</span> <span class="nx">axis</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">axis</span> <span class="o">+=</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span>
  <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">axis</span> <span class="o">&lt;</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">then</span> <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Axis out of bounds&#39;</span>
  <span class="nx">ni</span> <span class="o">=</span> <span class="nx">prod</span> <span class="nx">sa</span><span class="p">[...</span><span class="nx">axis</span><span class="p">]</span>
  <span class="nx">nj</span> <span class="o">=</span> <span class="nx">sa</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span>
  <span class="nx">nk</span> <span class="o">=</span> <span class="nx">prod</span> <span class="nx">sa</span><span class="p">[</span><span class="nx">axis</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">...]</span>
  <span class="nx">r</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">ni</span><span class="p">]</span>
    <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="nx">nj</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">..</span> <span class="mi">0</span><span class="p">]</span> <span class="nx">by</span> <span class="o">-</span><span class="mi">1</span>
      <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">nk</span><span class="p">]</span>
        <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">a</span><span class="p">[</span><span class="nx">k</span> <span class="o">+</span> <span class="nx">nk</span><span class="o">*</span><span class="p">(</span><span class="nx">j</span> <span class="o">+</span> <span class="nx">nj</span><span class="o">*</span><span class="nx">i</span><span class="p">)]</span>
  <span class="nx">withShape</span> <span class="nx">sa</span><span class="p">,</span> <span class="nx">r</span>

<span class="nx">dyadic</span>  <span class="s1">&#39;⌽&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Rotate</span>
  <span class="nx">a</span> <span class="o">=</span> <span class="nx">numericValueOf</span> <span class="nx">a</span>
  <span class="k">if</span> <span class="nx">a</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">or</span> <span class="nx">isSimple</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">b</span>
  <span class="nx">sb</span> <span class="o">=</span> <span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="nx">n</span> <span class="o">=</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">sb</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
  <span class="nx">a</span> <span class="o">%=</span> <span class="nx">n</span><span class="p">;</span> <span class="k">if</span> <span class="nx">a</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">a</span> <span class="o">+=</span> <span class="nx">n</span>
  <span class="nx">withShape</span> <span class="nx">sb</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="p">(</span><span class="nx">i</span> <span class="o">%</span> <span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="nx">i</span> <span class="o">%</span> <span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="nx">a</span><span class="p">)</span> <span class="o">%</span> <span class="nx">n</span><span class="p">])</span>

<span class="nx">monadic</span> <span class="s1">&#39;⊖&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">reverse</span> <span class="nx">a</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">axis</span> <span class="c1"># 1st axis reverse</span>

<span class="nx">dyadic</span> <span class="s1">&#39;⊖&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># 1st axis rotate</span>
  <span class="nx">a</span> <span class="o">=</span> <span class="nx">numericValueOf</span> <span class="nx">a</span>
  <span class="k">if</span> <span class="nx">a</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">or</span> <span class="nx">isSimple</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">b</span>
  <span class="nx">sb</span> <span class="o">=</span> <span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="nx">n</span> <span class="o">=</span> <span class="nx">sb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nx">k</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="nx">n</span>
  <span class="nx">a</span> <span class="o">%=</span> <span class="nx">n</span><span class="p">;</span> <span class="k">if</span> <span class="nx">a</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">a</span> <span class="o">+=</span> <span class="nx">n</span>
  <span class="nx">withShape</span> <span class="nx">sb</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="nx">b</span><span class="p">[((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">i</span> <span class="o">/</span> <span class="nx">k</span><span class="p">)</span> <span class="o">+</span> <span class="nx">a</span><span class="p">)</span> <span class="o">%</span> <span class="nx">n</span><span class="p">)</span> <span class="o">*</span> <span class="nx">k</span> <span class="o">+</span> <span class="p">(</span><span class="nx">i</span> <span class="o">%</span> <span class="nx">k</span><span class="p">)])</span>

<span class="nx">monadic</span> <span class="s1">&#39;⍉&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Transpose</span>
  <span class="nx">sa</span> <span class="o">=</span> <span class="nx">shapeOf</span> <span class="nx">a</span>
  <span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">a</span> <span class="c1"># has no effect on scalars or vectors</span>
  <span class="nx">sr</span> <span class="o">=</span> <span class="nx">sa</span><span class="p">[</span><span class="mi">0</span><span class="p">...].</span><span class="nx">reverse</span><span class="p">()</span>
  <span class="nx">psr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># partial products over sr</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">then</span> <span class="nx">psr</span><span class="p">.</span><span class="nx">push</span> <span class="nx">psr</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">*</span> <span class="nx">sr</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
  <span class="nx">r</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nx">rec</span> <span class="o">=</span> <span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">d</span> <span class="o">&gt;=</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="k">else</span> <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">sr</span><span class="p">[</span><span class="nx">d</span><span class="p">]]</span> <span class="k">then</span> <span class="nx">rec</span> <span class="nx">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">j</span><span class="o">*</span><span class="nx">psr</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span>
    <span class="mi">0</span>
  <span class="nx">rec</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
  <span class="nx">withShape</span> <span class="nx">sr</span><span class="p">,</span> <span class="nx">r</span>

<span class="nx">monadic</span> <span class="s1">&#39;↑&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># First</span>
  <span class="nx">a</span> <span class="o">=</span> <span class="nx">arrayValueOf</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="mi">0</span> <span class="c1"># todo: use the prototype of a</span>

<span class="nx">dyadic</span>  <span class="s1">&#39;↑&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Take</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[</span><span class="nx">a</span><span class="p">]</span>
  <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span>
    <span class="k">if</span> <span class="o">not</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">is</span> <span class="s1">&#39;number&#39;</span>
      <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Domain error: Left argument to ↑ must be a numeric scalar or vector.&#39;</span>
  <span class="k">if</span> <span class="nx">isSimple</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">and</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="nx">b</span> <span class="o">=</span> <span class="p">[</span><span class="nx">b</span><span class="p">]</span>
  <span class="nx">sb</span> <span class="o">=</span> <span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Length error: Left argument to ↑ must have as many elements as is the rank of its right argument.&#39;</span>
  <span class="nx">r</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nx">pa</span> <span class="o">=</span> <span class="k">for</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="mi">0</span>
  <span class="nx">pa</span><span class="p">[</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="nx">i</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="k">while</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">pa</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pa</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span> <span class="nx">i</span><span class="o">--</span>
  <span class="nx">rec</span> <span class="o">=</span> <span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">d</span> <span class="o">&gt;=</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="nx">k</span> <span class="o">/=</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">a</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span> <span class="nx">a</span><span class="p">[</span><span class="nx">d</span><span class="p">],</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">]]</span> <span class="k">then</span> <span class="nx">rec</span> <span class="nx">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">j</span> <span class="o">*</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">k</span>
        <span class="k">if</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">a</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span>
          <span class="k">for</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">-</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">])</span> <span class="o">*</span> <span class="nx">pa</span><span class="p">[</span><span class="nx">d</span><span class="p">]]</span> <span class="k">then</span> <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="mi">0</span> <span class="c1"># todo: use APL array prototype instead of 0</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">+</span> <span class="nx">a</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span>
          <span class="k">for</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="o">-</span><span class="p">(</span><span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">+</span> <span class="nx">a</span><span class="p">[</span><span class="nx">d</span><span class="p">])</span> <span class="o">*</span> <span class="nx">pa</span><span class="p">[</span><span class="nx">d</span><span class="p">]]</span> <span class="k">then</span> <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="mi">0</span> <span class="c1"># todo: use APL array prototype instead of 0</span>
        <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">+</span> <span class="nx">a</span><span class="p">[</span><span class="nx">d</span><span class="p">])</span> <span class="p">...</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">]]</span> <span class="k">then</span> <span class="nx">rec</span> <span class="nx">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">j</span> <span class="o">*</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">k</span>
    <span class="nx">r</span>
  <span class="nx">withShape</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">rec</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span>

<span class="nx">dyadic</span> <span class="s1">&#39;↓&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Drop</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[</span><span class="nx">a</span><span class="p">]</span>
  <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">when</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">isnt</span> <span class="s1">&#39;number&#39;</span> <span class="o">or</span> <span class="nx">x</span> <span class="o">isnt</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">x</span>
    <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Left argument to ↓ must be an integer or a vector of integers.&#39;</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">b</span> <span class="k">then</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">withShape</span> <span class="p">(</span><span class="k">for</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="mi">1</span><span class="p">),</span> <span class="nx">b</span>
  <span class="nx">sb</span> <span class="o">=</span> <span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;The left argument to ↓ must have length less than or equal to the rank of its right argument.&#39;</span>
  <span class="k">for</span> <span class="p">[</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">...</span><span class="nx">sb</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="nx">a</span><span class="p">.</span><span class="nx">push</span> <span class="mi">0</span>
  <span class="nx">lims</span> <span class="o">=</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">i</span><span class="p">]),</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span>
      <span class="k">else</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">])]</span>
  <span class="nx">r</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nx">rec</span> <span class="o">=</span> <span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">d</span> <span class="o">&gt;=</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="nx">n</span> <span class="o">/=</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="nx">lims</span><span class="p">[</span><span class="nx">d</span><span class="p">][</span><span class="mi">0</span><span class="p">]...</span><span class="nx">lims</span><span class="p">[</span><span class="nx">d</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
        <span class="nx">rec</span> <span class="nx">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">j</span><span class="o">*</span><span class="nx">n</span><span class="p">,</span> <span class="nx">n</span>
    <span class="mi">0</span>
  <span class="nx">rec</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span>
  <span class="nx">sr</span> <span class="o">=</span> <span class="k">for</span> <span class="p">[</span><span class="nx">lo</span><span class="p">,</span> <span class="nx">hi</span><span class="p">]</span> <span class="k">in</span> <span class="nx">lims</span> <span class="k">then</span> <span class="nx">hi</span> <span class="o">-</span> <span class="nx">lo</span>
  <span class="nx">withShape</span> <span class="nx">sr</span><span class="p">,</span> <span class="nx">r</span>

<span class="nx">monadic</span> <span class="s1">&#39;⊂&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Enclose</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="nx">a</span> <span class="k">else</span> <span class="nx">withShape</span> <span class="p">[],</span> <span class="p">[</span><span class="nx">a</span><span class="p">]</span>

<span class="nx">dyadic</span> <span class="s1">&#39;⊂&#39;</span> <span class="c1"># Partition (with axis)</span>

<span class="nx">monadic</span> <span class="s1">&#39;⊃&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Disclose</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">a</span>
  <span class="nx">sa</span> <span class="o">=</span> <span class="nx">shapeOf</span> <span class="nx">a</span>
  <span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nx">sr1</span> <span class="o">=</span> <span class="nx">shapeOf</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">...]</span>
    <span class="nx">sx</span> <span class="o">=</span> <span class="nx">shapeOf</span> <span class="nx">x</span>
    <span class="k">if</span> <span class="nx">sx</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="nx">sr1</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;The argument of ⊃ must contain elements of the same rank.&#39;</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">sr1</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
      <span class="nx">sr1</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span> <span class="nx">sr1</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">sx</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
  <span class="nx">sr</span> <span class="o">=</span> <span class="nx">shapeOf</span><span class="p">(</span><span class="nx">a</span><span class="p">).</span><span class="nx">concat</span> <span class="nx">sr1</span>
  <span class="nx">r</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span>
    <span class="nx">sx</span> <span class="o">=</span> <span class="nx">shapeOf</span> <span class="nx">x</span>
    <span class="nx">rec</span> <span class="o">=</span> <span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">N</span><span class="p">)</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>d: dimension, i: index in x, n: block size in x, N: block size in r</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">d</span> <span class="o">&gt;=</span> <span class="nx">sr1</span><span class="p">.</span><span class="nx">length</span>
        <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">x</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="nx">n</span> <span class="o">/=</span> <span class="nx">sx</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span>
        <span class="nx">N</span> <span class="o">/=</span> <span class="nx">sr1</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span>
        <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">sx</span><span class="p">[</span><span class="nx">d</span><span class="p">]]</span>
          <span class="nx">rec</span> <span class="nx">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">j</span> <span class="o">*</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">N</span>
        <span class="k">for</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">N</span> <span class="o">*</span> <span class="p">(</span><span class="nx">sr1</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">-</span> <span class="nx">sx</span><span class="p">[</span><span class="nx">d</span><span class="p">])]</span>
          <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="mi">0</span>
    <span class="nx">rec</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">prod</span> <span class="nx">sr1</span>
  <span class="nx">withShape</span> <span class="nx">sr</span><span class="p">,</span> <span class="nx">r</span>

<span class="nx">dyadic</span> <span class="s1">&#39;⊃&#39;</span> <span class="c1"># Pick</span>

<span class="nx">dyadic</span> <span class="s1">&#39;⌷&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Index</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>(a0 a1 ...)⌷b is equivalent to b[a0;a1;...]</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[</span><span class="nx">a</span><span class="p">]</span>
  <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">shape</span> <span class="o">and</span> <span class="nx">a</span><span class="p">.</span><span class="nx">shape</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Indices must be a scalar or a vector, not a higher-dimensional array.&#39;</span>
  <span class="nx">sb</span> <span class="o">=</span> <span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;The number of indices must be equal to the rank of the indexable.&#39;</span>
  <span class="nx">a</span> <span class="o">=</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">then</span> <span class="p">(</span><span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">x</span> <span class="k">then</span> <span class="nx">withShape</span> <span class="p">[],</span> <span class="p">[</span><span class="nx">x</span><span class="p">]</span> <span class="k">else</span> <span class="nx">x</span><span class="p">)</span>
  <span class="k">for</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">d</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="nx">x</span> <span class="k">when</span> <span class="o">not</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">y</span> <span class="o">is</span> <span class="s1">&#39;number&#39;</span> <span class="o">and</span> <span class="nx">y</span> <span class="o">is</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">y</span><span class="p">))</span>
    <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Indices must be integers&#39;</span>
  <span class="k">for</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">d</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="nx">x</span> <span class="k">when</span> <span class="o">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">])</span>
    <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Index out of bounds&#39;</span>
  <span class="nx">sr</span> <span class="o">=</span> <span class="p">[];</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">then</span> <span class="nx">sr</span> <span class="o">=</span> <span class="nx">sr</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">shapeOf</span> <span class="nx">x</span>
  <span class="nx">r</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nx">rec</span> <span class="o">=</span> <span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">d</span> <span class="o">&gt;=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="k">else</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="k">then</span> <span class="nx">rec</span> <span class="nx">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">n</span> <span class="o">/</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">]),</span> <span class="nx">n</span> <span class="o">/</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span>
    <span class="mi">0</span>
  <span class="nx">rec</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span>
  <span class="k">if</span> <span class="nx">sr</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="nx">withShape</span> <span class="nx">sr</span><span class="p">,</span> <span class="nx">r</span>

<span class="nx">monadic</span> <span class="s1">&#39;⍋&#39;</span> <span class="c1"># Grade up</span>
<span class="nx">monadic</span> <span class="s1">&#39;⍒&#39;</span> <span class="c1"># Grade down</span>
<span class="nx">monadic</span> <span class="s1">&#39;⊤&#39;</span> <span class="c1"># Encode</span>
<span class="nx">monadic</span> <span class="s1">&#39;���&#39;</span> <span class="c1"># Decode</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>monadic '⍺' # Picture format</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">monadic</span> <span class="s1">&#39;⍕&#39;</span> <span class="c1"># Format</span>
<span class="nx">dyadic</span> <span class="s1">&#39;⍕&#39;</span> <span class="c1"># Format by example or specification</span>
<span class="nx">monadic</span> <span class="s1">&#39;⍎&#39;</span> <span class="c1"># Execute</span>
<span class="nx">monadic</span> <span class="s1">&#39;⊣&#39;</span> <span class="c1"># Stop</span>
<span class="nx">dyadic</span> <span class="s1">&#39;⊣&#39;</span> <span class="c1"># Left</span>
<span class="nx">monadic</span> <span class="s1">&#39;⊢&#39;</span> <span class="c1"># Pass</span>
<span class="nx">dyadic</span> <span class="s1">&#39;⊢&#39;</span> <span class="c1"># Right</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Niladic functions and pseudo-variables</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">builtins</span><span class="p">[</span><span class="s1">&#39;get_⍬&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Note: Symbols <em>quad</em> (⎕) and <em>quote-quad</em> (⍞) are defined in a
platform-specific manner in <a href="browser.html">browser.coffee</a> (for browsers)
and <a href="command.html">command.coffee</a> (for node.js).</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h1>Built-in operators</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">reduce</span> <span class="o">=</span> <span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nx">invokedAsMonadic</span> <span class="o">=</span> <span class="o">not</span> <span class="nx">b</span><span class="o">?</span>
  <span class="k">if</span> <span class="nx">invokedAsMonadic</span> <span class="k">then</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">a</span><span class="p">;</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="nx">a</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">numericValueOf</span> <span class="nx">a</span>
  <span class="nx">isBackwards</span> <span class="o">=</span> <span class="nx">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span> <span class="k">if</span> <span class="nx">isBackwards</span> <span class="k">then</span> <span class="nx">a</span> <span class="o">=</span> <span class="o">-</span><span class="nx">a</span>
  <span class="nx">b</span> <span class="o">=</span> <span class="nx">arrayValueOf</span> <span class="nx">b</span>
  <span class="nx">sb</span> <span class="o">=</span> <span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="k">if</span> <span class="nx">axis</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">axis</span> <span class="o">+=</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span>
  <span class="nx">n</span> <span class="o">=</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span>
  <span class="k">if</span> <span class="nx">a</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">n</span>
  <span class="k">if</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span>
    <span class="nx">items</span> <span class="o">=</span> <span class="nx">b</span>
  <span class="k">else</span>
    <span class="nx">sItem</span> <span class="o">=</span> <span class="nx">sb</span><span class="p">[...</span><span class="nx">axis</span><span class="p">].</span><span class="nx">concat</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">...]</span> <span class="c1"># shape of an item</span>
    <span class="nx">k</span> <span class="o">=</span> <span class="nx">prod</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">...]</span>
    <span class="nx">items</span> <span class="o">=</span> <span class="k">for</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">n</span><span class="p">]</span> <span class="k">then</span> <span class="nx">withShape</span> <span class="nx">sItem</span><span class="p">,</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="nx">items</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">i</span> <span class="o">/</span> <span class="nx">k</span><span class="p">)</span> <span class="o">%</span> <span class="nx">n</span><span class="p">].</span><span class="nx">push</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
  <span class="nx">r</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nx">isBackwards</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">n</span> <span class="o">-</span> <span class="nx">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="nx">x</span> <span class="o">=</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">a</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span> <span class="p">(</span><span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">a</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">...</span> <span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="nx">by</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">f</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">items</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span> <span class="nx">x</span>
    <span class="k">else</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">n</span> <span class="o">-</span> <span class="nx">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="nx">x</span> <span class="o">=</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="p">(</span><span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">...</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">a</span><span class="p">]</span> <span class="nx">by</span> <span class="mi">1</span> <span class="k">then</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">f</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">items</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span> <span class="nx">x</span>
  <span class="k">if</span> <span class="nx">invokedAsMonadic</span> <span class="k">then</span> <span class="nx">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="nx">r</span>

<span class="nx">compressOrReplicate</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nx">sb</span> <span class="o">=</span> <span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="k">if</span> <span class="nx">axis</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">axis</span> <span class="o">+=</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span>
  <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">axis</span> <span class="o">&lt;</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">then</span> <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Axis out of bounds&#39;</span>
  <span class="nx">sr</span> <span class="o">=</span> <span class="nx">sb</span><span class="p">[</span><span class="mi">0</span><span class="p">...]</span>
  <span class="nx">sr</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">if</span> <span class="nx">shapeOf</span><span class="p">(</span><span class="nx">a</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Left argument to / must be an integer or a vector of integers&#39;</span>
  <span class="k">if</span> <span class="o">not</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">for</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span><span class="p">]]</span> <span class="k">then</span> <span class="nx">a</span>

  <span class="nx">nNonNegative</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># number of non-negative elements in a</span>
  <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">isnt</span> <span class="s1">&#39;number&#39;</span> <span class="o">or</span> <span class="nx">x</span> <span class="o">isnt</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">x</span> <span class="k">then</span> <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Left argument to / must be an integer or a vector of integers&#39;</span>
    <span class="nx">sr</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span> <span class="nx">x</span>
    <span class="nx">nNonNegative</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>

  <span class="nx">isExtensive</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="nx">isExpansive</span> <span class="o">=</span> <span class="nx">isHyperexpansive</span> <span class="o">=</span> <span class="kc">false</span>
  <span class="k">if</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span> <span class="o">isnt</span> <span class="mi">1</span>
    <span class="nx">isExtensive</span> <span class="o">=</span> <span class="kc">false</span>
    <span class="nx">isExpansive</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span>
    <span class="nx">isHyperexpansive</span> <span class="o">=</span> <span class="o">not</span> <span class="nx">isExpansive</span>
    <span class="k">if</span> <span class="nx">isHyperexpansive</span> <span class="o">and</span> <span class="p">(</span><span class="nx">nNonNegative</span> <span class="o">isnt</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span><span class="p">])</span>
      <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;For A/B, the length of B along the selected axis &#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;must be equal either to one, &#39;</span> <span class="o">+</span>                 <span class="c1"># extension</span>
                  <span class="s1">&#39;or the length of A, &#39;</span> <span class="o">+</span>                          <span class="c1"># expansion</span>
                  <span class="s1">&#39;or to the number of non-negative elements in A.&#39;</span> <span class="c1"># hyperexpansion</span>
  <span class="nx">r</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nx">ni</span> <span class="o">=</span> <span class="nx">prod</span> <span class="nx">sb</span><span class="p">[...</span> <span class="nx">axis</span><span class="p">]</span>
  <span class="nx">nj</span> <span class="o">=</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span>
  <span class="nx">nk</span> <span class="o">=</span> <span class="nx">prod</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">...]</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">ni</span><span class="p">]</span>
    <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span>
      <span class="k">if</span> <span class="nx">x</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">x</span><span class="p">]</span>
          <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">nk</span><span class="p">]</span>
            <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">b</span><span class="p">[</span><span class="nx">k</span> <span class="o">+</span> <span class="nx">nk</span><span class="o">*</span><span class="p">(</span><span class="nx">j</span> <span class="o">+</span> <span class="nx">nj</span><span class="o">*</span><span class="nx">i</span><span class="p">)]</span>
        <span class="nx">j</span> <span class="o">+=</span> <span class="nx">isExpansive</span> <span class="o">or</span> <span class="nx">isHyperexpansive</span>
      <span class="k">else</span>
        <span class="k">for</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="o">-</span><span class="nx">a</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span><span class="o">*</span><span class="nx">nk</span><span class="p">]</span>
          <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="mi">0</span> <span class="c1"># todo: prototype</span>
        <span class="nx">j</span> <span class="o">+=</span> <span class="nx">isExpansive</span>

  <span class="nx">withShape</span> <span class="nx">sr</span><span class="p">,</span> <span class="nx">r</span>

<span class="nx">postfixOperator</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Reduce, compress, or replicate</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">a</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
    <span class="nx">reduce</span> <span class="nx">a</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">axis</span>
  <span class="k">else</span>
    <span class="nx">compressOrReplicate</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">axis</span>

<span class="nx">postfixOperator</span> <span class="s1">&#39;⌿&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># 1st axis reduce, compress, or replicate</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">a</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
    <span class="nx">reduce</span> <span class="nx">a</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">axis</span>
  <span class="k">else</span>
    <span class="nx">compressOrReplicate</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">axis</span>

<span class="nx">postfixOperator</span> <span class="s1">&#39;¨&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Each</span>
  <span class="k">if</span> <span class="o">not</span> <span class="nx">b</span><span class="o">?</span> <span class="k">then</span> <span class="k">return</span> <span class="p">(</span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">arrayValueOf</span> <span class="nx">a</span> <span class="k">then</span> <span class="nx">f</span> <span class="nx">x</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="k">return</span> <span class="p">(</span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">arrayValueOf</span> <span class="nx">b</span> <span class="k">then</span> <span class="nx">f</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="k">return</span> <span class="p">(</span><span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="nx">f</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
  <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">return</span> <span class="p">(</span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">b</span> <span class="k">then</span> <span class="nx">f</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">x</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">return</span> <span class="p">(</span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">then</span> <span class="nx">f</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Length error&#39;</span>

<span class="nx">prefixOperator</span> <span class="s1">&#39;∘.&#39;</span><span class="p">,</span> <span class="nx">outerProduct</span> <span class="o">=</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="o">-&gt;</span>
  <span class="nx">f</span> <span class="o">=</span> <span class="nx">cpsify</span> <span class="nx">f</span>
  <span class="nx">cps</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Outer product</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">b</span><span class="o">?</span> <span class="k">then</span> <span class="k">return</span> <span class="o">-&gt;</span> <span class="nx">callback</span> <span class="nb">Error</span> <span class="s1">&#39;Operator ∘. (Outer product) works only with dyadic functions&#39;</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="nx">arrayValueOf</span> <span class="nx">a</span>
    <span class="nx">b</span> <span class="o">=</span> <span class="nx">arrayValueOf</span> <span class="nx">b</span>
    <span class="nx">r</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nx">ia</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">loopA</span> <span class="o">=</span> <span class="o">-&gt;</span>
      <span class="k">if</span> <span class="nx">ia</span> <span class="o">&lt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span>
        <span class="nx">ib</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nx">loopB</span> <span class="o">=</span> <span class="o">-&gt;</span>
          <span class="k">if</span> <span class="nx">ib</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span>
            <span class="o">-&gt;</span> <span class="nx">f</span> <span class="nx">a</span><span class="p">[</span><span class="nx">ia</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">ib</span><span class="p">],</span> <span class="kc">null</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span> <span class="o">-&gt;</span>
              <span class="k">if</span> <span class="nx">err</span> <span class="k">then</span> <span class="k">return</span> <span class="o">-&gt;</span> <span class="nx">callback</span> <span class="nx">err</span>
              <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">x</span>
              <span class="nx">ib</span><span class="o">++</span><span class="p">;</span> <span class="nx">loopB</span>
          <span class="k">else</span>
            <span class="nx">ia</span><span class="o">++</span><span class="p">;</span> <span class="nx">loopA</span>
      <span class="k">else</span>
        <span class="o">-&gt;</span> <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">withShape</span> <span class="p">(</span><span class="nx">shapeOf</span> <span class="nx">a</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span><span class="nx">shapeOf</span> <span class="nx">b</span><span class="p">),</span> <span class="nx">r</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>todo: the general formula for higher dimensions is
       A f.g B   &lt;=>   f/¨ (⊂[⍴⍴A]A)∘.g ⊂[1]B</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">infixOperator</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">g</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Inner product</span>
  <span class="nx">F</span> <span class="o">=</span> <span class="nx">reduce</span> <span class="nx">f</span>
  <span class="nx">G</span> <span class="o">=</span> <span class="nx">outerProduct</span> <span class="nx">g</span>
  <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">shapeOf</span><span class="p">(</span><span class="nx">a</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">or</span> <span class="nx">shapeOf</span><span class="p">(</span><span class="nx">b</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
      <span class="k">throw</span> <span class="nb">Error</span> <span class="s1">&#39;Inner product operator (.) is implemented only for arrays of rank no more than 1.&#39;</span>
    <span class="nx">F</span> <span class="nx">g</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span>

<span class="nx">postfixOperator</span> <span class="s1">&#39;⍣&#39;</span><span class="p">,</span> <span class="nx">cps</span> <span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="c1"># Power operator</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">f</span> <span class="o">isnt</span> <span class="s1">&#39;function&#39;</span> <span class="k">then</span> <span class="k">return</span> <span class="o">-&gt;</span> <span class="nx">callback0</span> <span class="nb">Error</span> <span class="s1">&#39;Left argument to ⍣ must be a function.&#39;</span>
  <span class="nx">f</span> <span class="o">=</span> <span class="nx">cpsify</span> <span class="nx">f</span>
  <span class="o">-&gt;</span> <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cps</span> <span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">callback1</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">n</span> <span class="o">isnt</span> <span class="s1">&#39;number&#39;</span> <span class="o">or</span> <span class="nx">n</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">or</span> <span class="nx">n</span> <span class="o">isnt</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">n</span> <span class="k">then</span> <span class="k">return</span> <span class="o">-&gt;</span> <span class="nx">callback</span> <span class="nb">Error</span> <span class="s1">&#39;Right argument to ⍣ must be a non-negative integer.&#39;</span>
    <span class="o">-&gt;</span> <span class="nx">callback1</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cps</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">callback2</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="nx">F</span> <span class="o">=</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span>
          <span class="nx">f</span> <span class="nx">a</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span> <span class="o">-&gt;</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="k">then</span> <span class="k">return</span> <span class="o">-&gt;</span> <span class="nx">callback2</span> <span class="nx">err</span>
            <span class="nx">a</span> <span class="o">=</span> <span class="nx">r</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">;</span> <span class="nx">F</span>
        <span class="k">else</span>
          <span class="o">-&gt;</span> <span class="nx">callback2</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">a</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 