<!DOCTYPE html>  <html> <head>   <title>builtins.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="builtins.html">                 builtins.coffee               </a>                                           <a class="source" href="compiler.html">                 compiler.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               builtins.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="c1">#!/usr/bin/env coffee</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>This file contains an implementation of APL's built-in functions and
operators.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h1>APL objects</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>APL's data structures are multidimensional arrays:</p>

<ul>
<li><p>(rank 0) Scalars---can be:</p>

<ul><li><p>simple scalars, like numbers and characters</p></li>
<li><p>an APL array of rank zero, containing exactly one element</p></li></ul></li>
<li><p>(rank 1) Vectors---sequences of APL objects with zero or more elements</p></li>
<li><p>(rank 2) Matrices---two-dimensional arrays of APL objects</p></li>
<li><p>(rank 3+) Cubes, etc</p></li>
</ul>

<p>APL arrays are not necessarily heterogenous, they may contain data of mixed
types.</p>

<p>An array in APL is aware of its own dimensions, so there is an essential
difference between a vector of vectors and a matrix.  To reflect this in
JavaScript objects, we use the following convention:</p>

<ul>
<li><p>APL scalars:</p>

<ul><li><p>Simple scalars: APL numbers are JavaScript numbers and APL characters
are JavaScript one-character strings.</p></li>
<li><p>A zero-rank APL array is a JavaScript array of size one with a
<code>shape</code> property of <code>[]</code>, e.g. created by:</p>

<pre><code>  var a = [123]; a.shape = [];
</code></pre></li></ul></li>
<li><p>An APL vector is a JavaScript array.</p></li>
<li><p>An APL matrix, cube, etc is a JavaScript array with an additional <code>shape</code>
property, describing the dimensions of the APL array.  E.g. a 2-by-2-by-3
cube of zeroes may be constructed via:</p>

<pre><code>  function createSomeCube() {
      var cube = [
          0, // Element at indices [0;0;0]
          0, // Element at indices [0;0;1]
          0, // Element at indices [0;0;2]
          0, // Element at indices [0;1;0]
          0, // Element at indices [0;1;1]
          // ...
          0  // Element at indices [1;1;2]
      ];
      cube.shape = [2, 2, 3];
      return cube;
  }
</code></pre>

<p>A vector's representation, as opposed to that of higher-dimensional
  arrays, is not required to have a <code>shape</code> property.  The shape of a
  vector <code>v</code> is assumed to be <code>[v.length]</code>, by convention.  Similarly, we
  could say that a scalar's shape is <code>[]</code> by convention.</p></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h1>APL prototypes</h1>

<p>Every object in APL, including empty arrays, has a <em>prototype</em> used whenever
"padding material" is needed, such as in the <em>take</em> function:</p>

<pre><code>5 ↑ 1 2 3     ⍝ gives      1 2 3 0 0
5 ↑ 'abc'     ⍝ gives      'abc  '
</code></pre>

<p>Prototypes are defined recursively:</p>

<ul>
<li><p>For numbers, the prototype is <code>0</code>.</p></li>
<li><p>For characters, the prototype is a space, <code>' '</code>.</p></li>
<li><p>For non-empty arrays, the prototype is the prototype of the first
element, repeated and arranged to fit the first element's shape.  E.g. the
prototype of <code>((1 2) 'a' (1 2 3))</code> is <code>(0 0)</code>.</p></li>
<li><p>For empty arrays, the prototype is determined by the operation used to
construct the array.  Usually it is copied from another array.</p></li>
</ul>

<p>To represent this in JavaScript, we simply use the first elements of arrays
and calculate it dynamically.  For empty arrays, we put an additional
<code>aplPrototype</code> property on the array, like so:</p>

<pre><code>var a = [];
a.aplPrototype = ' ';

var b = [];
b.aplPrototype = [0, 0, 0, 0];
b.aplPrototype.shape = [2, 2];
</code></pre>

<p>If an empty array has a prototype of <code>0</code>, we skip <code>aplPrototype</code> and leave
<code>0</code> as an implicit default.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">assert</span><span class="p">,</span> <span class="nx">die</span><span class="p">,</span> <span class="nx">inherit</span><span class="p">,</span> <span class="nx">cps</span><span class="p">,</span> <span class="nx">cpsify</span><span class="p">,</span> <span class="nx">isSimple</span><span class="p">,</span> <span class="nx">shapeOf</span><span class="p">,</span> <span class="nx">withShape</span><span class="p">,</span> <span class="nx">sum</span><span class="p">,</span> <span class="nx">prod</span><span class="p">,</span> <span class="nx">repeat</span><span class="p">,</span> <span class="nx">prototypeOf</span><span class="p">,</span> <span class="nx">withPrototype</span><span class="p">,</span> <span class="nx">withPrototypeCopiedFrom</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;./helpers&#39;</span>
<span class="p">{</span><span class="nx">min</span><span class="p">,</span> <span class="nx">max</span><span class="p">,</span> <span class="nx">floor</span><span class="p">,</span> <span class="nx">ceil</span><span class="p">,</span> <span class="nx">round</span><span class="p">,</span> <span class="nx">abs</span><span class="p">,</span> <span class="nx">random</span><span class="p">,</span> <span class="nx">exp</span><span class="p">,</span> <span class="nx">pow</span><span class="p">,</span> <span class="nx">log</span><span class="p">,</span> <span class="nx">PI</span><span class="p">,</span> <span class="nx">sqrt</span><span class="p">,</span> <span class="nx">sin</span><span class="p">,</span> <span class="nx">cos</span><span class="p">,</span> <span class="nx">tan</span><span class="p">,</span> <span class="nx">asin</span><span class="p">,</span> <span class="nx">acos</span><span class="p">,</span> <span class="nx">atan</span><span class="p">}</span> <span class="o">=</span> <span class="nb">Math</span>
<span class="nv">repr = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h1>Type coersion helpers</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">array = </span><span class="nf">(x) -&gt;</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">x</span> <span class="k">then</span> <span class="p">[</span><span class="nx">x</span><span class="p">]</span> <span class="k">else</span> <span class="nx">x</span>

<span class="nv">num = </span><span class="nf">(x) -&gt;</span>
  <span class="k">if</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span><span class="o">?</span>
    <span class="nx">assert</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Numeric scalar or singleton expected&#39;</span>
    <span class="nv">x = </span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nx">assert</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">is</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="s1">&#39;Numeric scalar or singleton expected&#39;</span>
  <span class="nx">x</span>

<span class="nv">bool = </span><span class="nf">(x) -&gt;</span>
  <span class="nv">x = </span><span class="nx">num</span> <span class="nx">x</span>
  <span class="nx">assert</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;Boolean values must be either 0 or 1&#39;</span>
  <span class="nx">x</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h1>DSL for defining built-in symbols</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.builtins = builtins = </span><span class="p">{}</span>

<span class="nv">tmp = monadic: </span><span class="p">{},</span> <span class="nv">dyadic: </span><span class="p">{}</span>

<span class="nv">def = </span><span class="nf">(h, name, description, f) -&gt;</span>
  <span class="nx">assert</span> <span class="k">typeof</span> <span class="nx">name</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
  <span class="nx">assert</span> <span class="k">typeof</span> <span class="nx">description</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
  <span class="nx">f</span> <span class="o">?=</span> <span class="o">-&gt;</span> <span class="nx">die</span> <span class="s2">&quot;Function #{name} #{description} is not implemented.&quot;</span>
  <span class="nx">assert</span> <span class="k">typeof</span> <span class="nx">f</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
  <span class="nx">assert</span> <span class="o">not</span> <span class="nx">h</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span><span class="o">?</span><span class="p">,</span> <span class="s2">&quot;Redefinition of function #{name} #{description}&quot;</span>
  <span class="nx">h</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">f</span>

<span class="nv">monadic         = </span><span class="nf">(a...) -&gt;</span> <span class="nx">def</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">monadic</span><span class="p">,</span> <span class="nx">a</span><span class="p">...</span>
<span class="nv">dyadic          = </span><span class="nf">(a...) -&gt;</span> <span class="nx">def</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">dyadic</span><span class="p">,</span>  <span class="nx">a</span><span class="p">...</span>
<span class="nv">prefixOperator  = </span><span class="nf">(a...) -&gt;</span> <span class="p">((</span><span class="nx">def</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">monadic</span><span class="p">,</span> <span class="nx">a</span><span class="p">...).</span><span class="nx">aplMetaInfo</span> <span class="o">?=</span> <span class="p">{}).</span><span class="nv">isPrefixOperator = </span><span class="kc">true</span>
<span class="nv">postfixOperator = </span><span class="nf">(a...) -&gt;</span> <span class="p">((</span><span class="nx">def</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">monadic</span><span class="p">,</span> <span class="nx">a</span><span class="p">...).</span><span class="nx">aplMetaInfo</span> <span class="o">?=</span> <span class="p">{}).</span><span class="nv">isPostfixOperator = </span><span class="kc">true</span>
<span class="nv">infixOperator   = </span><span class="nf">(a...) -&gt;</span> <span class="p">((</span><span class="nx">def</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">dyadic</span><span class="p">,</span>  <span class="nx">a</span><span class="p">...).</span><span class="nx">aplMetaInfo</span> <span class="o">?=</span> <span class="p">{}).</span><span class="nv">isInfixOperator = </span><span class="kc">true</span>

<span class="nv">withMetaInfoFrom = </span><span class="nf">(f, g) -&gt;</span>
  <span class="nx">assert</span> <span class="k">typeof</span> <span class="nx">f</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
  <span class="nx">assert</span> <span class="k">typeof</span> <span class="nx">g</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
  <span class="nv">g.aplMetaInfo = </span><span class="k">if</span> <span class="nx">f</span><span class="p">.</span><span class="nx">aplMetaInfo</span> <span class="k">then</span> <span class="nx">inherit</span> <span class="nx">f</span><span class="p">.</span><span class="nx">aplMetaInfo</span> <span class="k">else</span> <span class="p">{}</span>
  <span class="nx">g</span>

<span class="nv">overloadable = </span><span class="nf">(symbol, f) -&gt;</span>
  <span class="nx">assert</span> <span class="k">typeof</span> <span class="nx">symbol</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
  <span class="nx">assert</span> <span class="k">typeof</span> <span class="nx">f</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
  <span class="nx">withMetaInfoFrom</span> <span class="nx">f</span><span class="p">,</span>
    <span class="nf">(b, a, args...) -&gt;</span>
      <span class="k">if</span> <span class="k">typeof</span> <span class="nx">b</span><span class="o">?</span><span class="p">[</span><span class="nx">symbol</span><span class="p">]</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span> <span class="k">then</span> <span class="nx">b</span><span class="p">[</span><span class="nx">symbol</span><span class="p">]</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span>
      <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">a</span><span class="o">?</span><span class="p">[</span><span class="nx">symbol</span><span class="p">]</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span> <span class="k">then</span> <span class="nx">a</span><span class="p">[</span><span class="nx">symbol</span><span class="p">]</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span>
      <span class="k">else</span> <span class="nx">f</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span>

<span class="nv">ambivalent = </span><span class="nf">(symbol, f1, f2) -&gt;</span>
  <span class="nx">assert</span> <span class="k">typeof</span> <span class="nx">symbol</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
  <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">f1</span> <span class="o">and</span> <span class="nx">f2</span><span class="p">)</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">f1</span> <span class="o">or</span> <span class="nx">f2</span>
  <span class="nx">assert</span> <span class="k">typeof</span> <span class="nx">f1</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
  <span class="nx">assert</span> <span class="k">typeof</span> <span class="nx">f2</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
  <span class="nv">F = </span><span class="nf">(b, a, args...) -&gt;</span> <span class="k">if</span> <span class="nx">a</span><span class="o">?</span> <span class="k">then</span> <span class="nx">f2</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span> <span class="k">else</span> <span class="nx">f1</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span>

<span class="nv">endOfBuiltins = </span><span class="o">-&gt;</span>
  <span class="nv">ks = </span><span class="p">(</span><span class="k">for</span> <span class="nx">k</span> <span class="k">of</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">monadic</span> <span class="k">then</span> <span class="nx">k</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span><span class="k">for</span> <span class="nx">k</span> <span class="k">of</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">dyadic</span> <span class="k">when</span> <span class="o">not</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">monadic</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span><span class="o">?</span> <span class="k">then</span> <span class="nx">k</span><span class="p">)</span>
  <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">ks</span>
    <span class="nv">f1 = </span><span class="nx">tmp</span><span class="p">.</span><span class="nx">monadic</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">f1</span><span class="o">?</span>
      <span class="nv">f1 = </span><span class="nx">overloadable</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">f1</span>
      <span class="nv">f1 = </span><span class="nx">maybeMakePervasive</span> <span class="nx">f1</span>
    <span class="nv">f2 = </span><span class="nx">tmp</span><span class="p">.</span><span class="nx">dyadic</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">f2</span><span class="o">?</span>
      <span class="nv">f2 = </span><span class="nx">overloadable</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">f2</span>
      <span class="nv">f2 = </span><span class="nx">maybeMakePervasive</span> <span class="nx">f2</span>
    <span class="nx">builtins</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ambivalent</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">f1</span><span class="p">,</span> <span class="nx">f2</span><span class="p">)</span>
  <span class="nv">tmp = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Just mark <code>f</code> as pervasive for now, it will be made pervasive in `endOfBuiltins()</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">pervasive = </span><span class="nf">(f) -&gt;</span>
  <span class="nx">assert</span> <span class="k">typeof</span> <span class="nx">f</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
  <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">aplMetaInfo</span> <span class="o">?=</span> <span class="p">{}).</span><span class="nv">isPervasive = </span><span class="kc">true</span>
  <span class="nx">f</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p><code>maybeMakePervasive(f)</code> is a decorator which takes a scalar function <code>f</code> and makes it
propagate through arrays, if it has <code>f.aplMetaInfo.isPervasive</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">maybeMakePervasive = </span><span class="nf">(f) -&gt;</span>
  <span class="nx">assert</span> <span class="k">typeof</span> <span class="nx">f</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
  <span class="k">if</span> <span class="o">not</span> <span class="nx">f</span><span class="p">.</span><span class="nx">aplMetaInfo</span><span class="o">?</span><span class="p">.</span><span class="nx">isPervasive</span>
    <span class="nx">f</span>
  <span class="k">else</span>
    <span class="nx">withMetaInfoFrom</span> <span class="nx">f</span><span class="p">,</span> <span class="p">(</span><span class="nv">F = </span><span class="nf">(b, a) -&gt;</span>
      <span class="k">if</span> <span class="nx">a</span><span class="o">?</span> <span class="c1"># dyadic pervasiveness</span>
        <span class="k">if</span> <span class="nx">isSimple</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">and</span> <span class="nx">isSimple</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="k">then</span> <span class="nx">f</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">a</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="nx">withShape</span> <span class="nx">b</span><span class="p">.</span><span class="nx">shape</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">b</span> <span class="k">then</span> <span class="nx">F</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">b</span> <span class="k">then</span> <span class="nx">withShape</span> <span class="nx">a</span><span class="p">.</span><span class="nx">shape</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">then</span> <span class="nx">F</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nv">sa = </span><span class="nx">shapeOf</span> <span class="nx">a</span><span class="p">;</span> <span class="nv">sb = </span><span class="nx">shapeOf</span> <span class="nx">b</span>
          <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">min</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
            <span class="nx">assert</span> <span class="nx">sa</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">is</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="s1">&#39;Length error&#39;</span>
          <span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span>
            <span class="nv">k = </span><span class="nx">prod</span> <span class="nx">sa</span><span class="p">[</span><span class="nx">sb</span><span class="p">.</span><span class="nx">length</span><span class="p">...]</span>
            <span class="nx">withShape</span> <span class="nx">sa</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="nx">F</span> <span class="nx">b</span><span class="p">[</span><span class="nx">floor</span> <span class="nx">i</span> <span class="err">/ k], a[i])</span>
          <span class="k">else</span> <span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span>
            <span class="nv">k = </span><span class="nx">prod</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">sa</span><span class="p">.</span><span class="nx">length</span><span class="p">...]</span>
            <span class="nx">withShape</span> <span class="nx">sb</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="nx">F</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">a</span><span class="p">[</span><span class="nx">floor</span> <span class="nx">i</span> <span class="err">/ k])</span>
          <span class="k">else</span>
            <span class="nx">withShape</span> <span class="nx">sa</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="nx">F</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
      <span class="k">else</span> <span class="c1"># monadic pervasiveness</span>
        <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">b</span> <span class="k">then</span> <span class="nx">f</span> <span class="nx">b</span>
        <span class="k">else</span> <span class="nx">withShape</span> <span class="nx">b</span><span class="p">.</span><span class="nx">shape</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">b</span> <span class="k">then</span> <span class="nx">F</span> <span class="nx">x</span><span class="p">)</span>
    <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h1>Built-in functions</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">monadic</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;Conjugate&#39;</span><span class="p">,</span>      <span class="nx">pervasive</span> <span class="nf">(x) -&gt;</span> <span class="nx">x</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;Add&#39;</span><span class="p">,</span>            <span class="nx">pervasive</span> <span class="nf">(y, x) -&gt;</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span>
<span class="nx">monadic</span> <span class="s1">&#39;−&#39;</span><span class="p">,</span> <span class="s1">&#39;Negate&#39;</span><span class="p">,</span>         <span class="nx">pervasive</span> <span class="nf">(x) -&gt;</span> <span class="o">-</span><span class="nx">x</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;−&#39;</span><span class="p">,</span> <span class="s1">&#39;Subtract&#39;</span><span class="p">,</span>       <span class="nx">pervasive</span> <span class="nf">(y, x) -&gt;</span> <span class="nx">x</span> <span class="o">-</span> <span class="nx">y</span>
<span class="nx">monadic</span> <span class="s1">&#39;×&#39;</span><span class="p">,</span> <span class="s1">&#39;Sign of&#39;</span><span class="p">,</span>        <span class="nx">pervasive</span> <span class="nf">(x) -&gt;</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;×&#39;</span><span class="p">,</span> <span class="s1">&#39;Multiply&#39;</span><span class="p">,</span>       <span class="nx">pervasive</span> <span class="nf">(y, x) -&gt;</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">y</span>
<span class="nx">monadic</span> <span class="s1">&#39;÷&#39;</span><span class="p">,</span> <span class="s1">&#39;Reciprocal&#39;</span><span class="p">,</span>     <span class="nx">pervasive</span> <span class="nf">(x) -&gt;</span> <span class="mi">1</span> <span class="o">/</span> <span class="nx">x</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;÷&#39;</span><span class="p">,</span> <span class="s1">&#39;Divide&#39;</span><span class="p">,</span>         <span class="nx">pervasive</span> <span class="nf">(y, x) -&gt;</span> <span class="nx">x</span> <span class="err">/ y</span>
<span class="nx">monadic</span> <span class="s1">&#39;⌈&#39;</span><span class="p">,</span> <span class="s1">&#39;Ceiling&#39;</span><span class="p">,</span>        <span class="nx">pervasive</span> <span class="nf">(x) -&gt;</span> <span class="nx">ceil</span> <span class="nx">x</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;⌈&#39;</span><span class="p">,</span> <span class="s1">&#39;Greater of&#39;</span><span class="p">,</span>     <span class="nx">pervasive</span> <span class="nf">(y, x) -&gt;</span> <span class="nx">max</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span>
<span class="nx">monadic</span> <span class="s1">&#39;⌊&#39;</span><span class="p">,</span> <span class="s1">&#39;Floor&#39;</span><span class="p">,</span>          <span class="nx">pervasive</span> <span class="nf">(x) -&gt;</span> <span class="nx">floor</span> <span class="nx">x</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;⌊&#39;</span><span class="p">,</span> <span class="s1">&#39;Lesser of&#39;</span><span class="p">,</span>      <span class="nx">pervasive</span> <span class="nf">(y, x) -&gt;</span> <span class="nx">min</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span>
<span class="nx">monadic</span> <span class="s1">&#39;∣&#39;</span><span class="p">,</span> <span class="s1">&#39;Absolute value&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(x) -&gt;</span> <span class="nx">abs</span> <span class="nx">x</span>
<span class="nx">dyadic</span>  <span class="s1">&#39;∣&#39;</span><span class="p">,</span> <span class="s1">&#39;Residue&#39;</span><span class="p">,</span>        <span class="nx">pervasive</span> <span class="nf">(y, x) -&gt;</span> <span class="nx">y</span> <span class="o">%</span> <span class="nx">x</span>

<span class="nx">monadic</span> <span class="s1">&#39;⍳&#39;</span><span class="p">,</span> <span class="s1">&#39;Index generate&#39;</span><span class="p">,</span> <span class="nf">(x) -&gt;</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">floor</span> <span class="nx">num</span> <span class="nx">x</span><span class="p">]</span>

<span class="nx">dyadic</span>  <span class="s1">&#39;⍳&#39;</span><span class="p">,</span> <span class="s1">&#39;Index of&#39;</span><span class="p">,</span> <span class="nf">(b, a) -&gt;</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="nv">a = </span><span class="p">[</span><span class="nx">a</span><span class="p">]</span>
  <span class="k">else</span> <span class="nx">assert</span> <span class="nx">shapeOf</span><span class="p">(</span><span class="nx">a</span><span class="p">).</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Left argument to ⍳ must be of rank no more than 1.&#39;</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">b</span> <span class="k">then</span> <span class="nv">b = </span><span class="p">[</span><span class="nx">b</span><span class="p">]</span>
  <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="nx">b</span>
    <span class="nv">pos = </span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">for</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">when</span> <span class="nx">match</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span> <span class="k">then</span> <span class="nv">pos = </span><span class="nx">i</span><span class="p">;</span> <span class="k">break</span>
    <span class="nx">pos</span>

<span class="nx">monadic</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;Roll&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(x) -&gt;</span> <span class="nx">floor</span> <span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">max</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">floor</span> <span class="nx">num</span> <span class="nx">x</span>
<span class="nx">dyadic</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;Deal&#39;</span><span class="p">,</span> <span class="nf">(y, x) -&gt;</span>
  <span class="nv">x = </span><span class="nx">max</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">floor</span> <span class="nx">num</span> <span class="nx">x</span>
  <span class="nv">y = </span><span class="nx">max</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">floor</span> <span class="nx">num</span> <span class="nx">y</span>
  <span class="nx">assert</span> <span class="nx">x</span> <span class="o">&lt;=</span> <span class="nx">y</span><span class="p">,</span> <span class="s1">&#39;Domain error: left argument of ? must not be greater than its right argument.&#39;</span>
  <span class="nv">available = </span><span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">y</span><span class="p">]</span>
  <span class="k">for</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">x</span><span class="p">]</span> <span class="k">then</span> <span class="nx">available</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">floor</span><span class="p">(</span><span class="nx">available</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="nx">random</span><span class="p">()),</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="nx">monadic</span> <span class="s1">&#39;⋆&#39;</span><span class="p">,</span> <span class="s1">&#39;Exponentiate&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(x) -&gt;</span> <span class="nx">exp</span> <span class="nx">num</span> <span class="nx">x</span>
<span class="nx">dyadic</span> <span class="s1">&#39;⋆&#39;</span><span class="p">,</span> <span class="s1">&#39;To the power of&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(y, x) -&gt;</span> <span class="nx">pow</span> <span class="nx">num</span><span class="p">(</span><span class="nx">x</span><span class="p">),</span> <span class="nx">num</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span>
<span class="nx">monadic</span> <span class="s1">&#39;⍟&#39;</span><span class="p">,</span> <span class="s1">&#39;Natural logarithm&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(x) -&gt;</span> <span class="nx">log</span> <span class="nx">x</span>
<span class="nx">dyadic</span> <span class="s1">&#39;⍟&#39;</span><span class="p">,</span> <span class="s1">&#39;Logarithm to the base&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(y, x) -&gt;</span> <span class="nx">log</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="o">/</span> <span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>

<span class="nx">monadic</span> <span class="s1">&#39;○&#39;</span><span class="p">,</span> <span class="s1">&#39;Pi times&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(x) -&gt;</span> <span class="nx">PI</span> <span class="o">*</span> <span class="nx">x</span>
<span class="nx">dyadic</span> <span class="s1">&#39;○&#39;</span><span class="p">,</span> <span class="s1">&#39;Circular and hyperbolic functions&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(x, i) -&gt;</span>
  <span class="k">switch</span> <span class="nx">i</span>
    <span class="k">when</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">)</span>
    <span class="k">when</span> <span class="mi">1</span> <span class="k">then</span> <span class="nx">sin</span> <span class="nx">x</span>
    <span class="k">when</span> <span class="mi">2</span> <span class="k">then</span> <span class="nx">cos</span> <span class="nx">x</span>
    <span class="k">when</span> <span class="mi">3</span> <span class="k">then</span> <span class="nx">tan</span> <span class="nx">x</span>
    <span class="k">when</span> <span class="mi">4</span> <span class="k">then</span> <span class="nx">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">)</span>
    <span class="k">when</span> <span class="mi">5</span> <span class="k">then</span> <span class="p">(</span><span class="nx">exp</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="c1"># sinh</span>
    <span class="k">when</span> <span class="mi">6</span> <span class="k">then</span> <span class="p">(</span><span class="nx">exp</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="c1"># cosh</span>
    <span class="k">when</span> <span class="mi">7</span> <span class="k">then</span> <span class="nv">ex = </span><span class="nx">exp</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">x</span><span class="p">);</span> <span class="p">(</span><span class="nx">ex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">ex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># tanh</span>
    <span class="k">when</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="nx">asin</span> <span class="nx">x</span>
    <span class="k">when</span> <span class="o">-</span><span class="mi">2</span> <span class="k">then</span> <span class="nx">acos</span> <span class="nx">x</span>
    <span class="k">when</span> <span class="o">-</span><span class="mi">3</span> <span class="k">then</span> <span class="nx">atan</span> <span class="nx">x</span>
    <span class="k">when</span> <span class="o">-</span><span class="mi">4</span> <span class="k">then</span> <span class="nx">sqrt</span><span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">when</span> <span class="o">-</span><span class="mi">5</span> <span class="k">then</span> <span class="nx">log</span><span class="p">(</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">sqrt</span><span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="c1"># arcsinh</span>
    <span class="k">when</span> <span class="o">-</span><span class="mi">6</span> <span class="k">then</span> <span class="nx">log</span><span class="p">(</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">sqrt</span><span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="c1"># arccosh</span>
    <span class="k">when</span> <span class="o">-</span><span class="mi">7</span> <span class="k">then</span> <span class="nx">log</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="nx">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">x</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="c1"># arctanh</span>
    <span class="k">else</span> <span class="nx">die</span> <span class="s1">&#39;Unknown circular or hyperbolic function &#39;</span> <span class="o">+</span> <span class="nx">i</span>

<span class="nx">monadic</span> <span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="s1">&#39;Factorial&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(a) -&gt;</span>
  <span class="nv">n = a = </span><span class="nx">floor</span> <span class="nx">num</span> <span class="nx">a</span> <span class="c1"># todo: &quot;Gamma&quot; function for non-integer argument</span>
  <span class="nv">r = </span><span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="k">if</span> <span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">2</span> <span class="p">..</span> <span class="nx">n</span><span class="p">]</span> <span class="k">then</span> <span class="nx">r</span> <span class="o">*=</span> <span class="nx">i</span><span class="p">);</span> <span class="nx">r</span>

<span class="nx">dyadic</span> <span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="s1">&#39;Binomial&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(b, a) -&gt;</span>
  <span class="nv">k = </span><span class="nx">floor</span> <span class="nx">num</span> <span class="nx">a</span>
  <span class="nv">n = </span><span class="nx">floor</span> <span class="nx">num</span> <span class="nx">b</span>
  <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">k</span> <span class="o">&lt;=</span> <span class="nx">n</span><span class="p">)</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span> <span class="c1"># todo: Special cases for negatives and non-integers</span>
  <span class="k">if</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">k</span> <span class="o">&gt;</span> <span class="nx">n</span> <span class="k">then</span> <span class="nv">k = </span><span class="nx">n</span> <span class="o">-</span> <span class="nx">k</span> <span class="c1"># do less work</span>
  <span class="nv">r = </span><span class="mi">1</span><span class="p">;</span> <span class="p">(</span><span class="k">if</span> <span class="nx">k</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span> <span class="p">..</span> <span class="nx">k</span><span class="p">]</span> <span class="k">then</span> <span class="nv">r = </span><span class="nx">r</span> <span class="o">*</span> <span class="p">(</span><span class="nx">n</span> <span class="o">-</span> <span class="nx">k</span> <span class="o">+</span> <span class="nx">i</span><span class="p">)</span> <span class="o">/</span> <span class="nx">i</span><span class="p">);</span> <span class="nx">r</span>

<span class="nx">monadic</span> <span class="s1">&#39;⌹&#39;</span><span class="p">,</span> <span class="s1">&#39;Matrix inverse&#39;</span> <span class="c1"># todo</span>
<span class="nx">dyadic</span> <span class="s1">&#39;⌹&#39;</span><span class="p">,</span> <span class="s1">&#39;Matrix divide&#39;</span> <span class="c1"># todo</span>

<span class="nx">dyadic</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;Less than&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(y, x) -&gt;</span> <span class="o">+</span><span class="p">(</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">y</span><span class="p">)</span>
<span class="nx">dyadic</span> <span class="s1">&#39;≤&#39;</span><span class="p">,</span> <span class="s1">&#39;Less than or equal&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(y, x) -&gt;</span> <span class="o">+</span><span class="p">(</span><span class="nx">x</span> <span class="o">&lt;=</span> <span class="nx">y</span><span class="p">)</span>
<span class="nx">dyadic</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;Equal&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(y, x) -&gt;</span> <span class="o">+</span><span class="p">(</span><span class="nx">x</span> <span class="o">is</span> <span class="nx">y</span><span class="p">)</span>
<span class="nx">dyadic</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;Greater than&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(y, x) -&gt;</span> <span class="o">+</span><span class="p">(</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">y</span><span class="p">)</span>
<span class="nx">dyadic</span> <span class="s1">&#39;≥&#39;</span><span class="p">,</span> <span class="s1">&#39;Greater than or equal&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(y, x) -&gt;</span> <span class="o">+</span><span class="p">(</span><span class="nx">x</span> <span class="o">&gt;=</span> <span class="nx">y</span><span class="p">)</span>
<span class="nx">dyadic</span> <span class="s1">&#39;≠&#39;</span><span class="p">,</span> <span class="s1">&#39;Not equal&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(y, x) -&gt;</span> <span class="o">+</span><span class="p">(</span><span class="nx">x</span> <span class="o">isnt</span> <span class="nx">y</span><span class="p">)</span>

<span class="nx">monadic</span> <span class="s1">&#39;≡&#39;</span><span class="p">,</span> <span class="s1">&#39;Depth&#39;</span><span class="p">,</span> <span class="nv">depthOf = </span><span class="nf">(a) -&gt;</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span>
  <span class="nv">r = </span><span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">then</span> <span class="nv">r = </span><span class="nx">max</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">depthOf</span> <span class="nx">x</span><span class="p">);</span> <span class="nx">r</span> <span class="o">+</span> <span class="mi">1</span>

<span class="nx">dyadic</span> <span class="s1">&#39;≡&#39;</span><span class="p">,</span> <span class="s1">&#39;Match&#39;</span><span class="p">,</span> <span class="nv">match = </span><span class="nf">(b, a) -&gt;</span>
  <span class="k">if</span> <span class="nx">isSimple</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">and</span> <span class="nx">isSimple</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="k">then</span> <span class="k">return</span> <span class="o">+</span><span class="p">(</span><span class="nx">a</span> <span class="o">is</span> <span class="nx">b</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">isSimple</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">isnt</span> <span class="nx">isSimple</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Compare by shape</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">sa = </span><span class="nx">shapeOf</span> <span class="nx">a</span>
  <span class="nv">sb = </span><span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">sa</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">when</span> <span class="nx">sa</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">isnt</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Compare by elements</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">match</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Compare by prototype</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">1</span>
  <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">aplPrototype</span><span class="o">?</span> <span class="o">or</span> <span class="nx">b</span><span class="p">.</span><span class="nx">aplPrototype</span><span class="o">?</span><span class="p">)</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">1</span>
  <span class="nx">match</span> <span class="nx">prototypeOf</span><span class="p">(</span><span class="nx">a</span><span class="p">),</span> <span class="nx">prototypeOf</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span>

<span class="nx">dyadic</span> <span class="s1">&#39;≢&#39;</span><span class="p">,</span> <span class="s1">&#39;Not match&#39;</span><span class="p">,</span> <span class="nf">(b, a) -&gt;</span> <span class="o">+not</span> <span class="nx">match</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">a</span>

<span class="nx">monadic</span> <span class="s1">&#39;∈&#39;</span><span class="p">,</span> <span class="s1">&#39;Enlist&#39;</span><span class="p">,</span> <span class="nf">(a) -&gt;</span>
  <span class="nv">r = </span><span class="p">[]</span>
  <span class="nv">rec = </span><span class="nf">(x) -&gt;</span> <span class="p">(</span><span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">x</span> <span class="k">then</span> <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">x</span> <span class="k">else</span> <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="nx">x</span> <span class="k">then</span> <span class="nx">rec</span> <span class="nx">y</span><span class="p">);</span> <span class="nx">r</span>
  <span class="nx">rec</span> <span class="nx">a</span>

<span class="nx">dyadic</span> <span class="s1">&#39;∈&#39;</span><span class="p">,</span> <span class="s1">&#39;Membership&#39;</span><span class="p">,</span> <span class="nf">(b, a) -&gt;</span>
  <span class="nv">a = </span><span class="nx">array</span> <span class="nx">a</span>
  <span class="nv">b = </span><span class="nx">array</span> <span class="nx">b</span>
  <span class="nx">withShape</span> <span class="nx">a</span><span class="p">.</span><span class="nx">shape</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">then</span> <span class="o">+</span><span class="p">(</span><span class="nx">x</span> <span class="k">in</span> <span class="nx">b</span><span class="p">))</span>

<span class="nx">dyadic</span> <span class="s1">&#39;⍷&#39;</span><span class="p">,</span> <span class="s1">&#39;Find&#39;</span><span class="p">,</span> <span class="nf">(b, a) -&gt;</span>
  <span class="nv">sa = </span><span class="nx">shapeOf</span> <span class="nx">a</span>
  <span class="nv">sb = </span><span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">b</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">isSimple</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">and</span> <span class="nx">match</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">a</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="nv">a = </span><span class="p">[</span><span class="nx">a</span><span class="p">]</span>
  <span class="nv">r = </span><span class="nx">withShape</span> <span class="nx">sb</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="mi">0</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">r</span>
  <span class="k">while</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">unshift</span> <span class="mi">1</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">sb</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="k">if</span> <span class="nx">sa</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">r</span>

  <span class="nv">indices = </span><span class="nb">Array</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span>

  <span class="nv">rec = </span><span class="nf">(d, ir) -&gt;</span>
    <span class="k">if</span> <span class="nx">d</span> <span class="o">&lt;</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">-</span> <span class="nx">sa</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="nx">indices</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span>
        <span class="nx">rec</span> <span class="nx">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">ir</span> <span class="o">*</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">+</span> <span class="nx">i</span>
    <span class="k">else</span>
      <span class="nx">r</span><span class="p">[</span><span class="nx">ir</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rec2</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

  <span class="nv">rec2 = </span><span class="nf">(d, ia, ib) -&gt;</span>
    <span class="k">if</span> <span class="nx">d</span> <span class="o">&lt;</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">sa</span><span class="p">[</span><span class="nx">d</span><span class="p">]]</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">rec2</span> <span class="nx">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">ia</span> <span class="o">*</span> <span class="nx">sa</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">+</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">ib</span> <span class="o">*</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">+</span> <span class="nx">indices</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">+</span> <span class="nx">i</span>
          <span class="k">return</span> <span class="mi">0</span>
      <span class="mi">1</span>
    <span class="k">else</span>
      <span class="nx">match</span> <span class="nx">a</span><span class="p">[</span><span class="nx">ia</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">ib</span><span class="p">]</span>

  <span class="nx">rec</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
  <span class="nx">r</span>

<span class="nx">monadic</span> <span class="s1">&#39;∪&#39;</span><span class="p">,</span> <span class="s1">&#39;Unique&#39;</span> <span class="c1"># todo</span>
<span class="nx">dyadic</span> <span class="s1">&#39;∪&#39;</span><span class="p">,</span> <span class="s1">&#39;Union&#39;</span> <span class="c1"># todo</span>
<span class="nx">dyadic</span> <span class="s1">&#39;∩&#39;</span><span class="p">,</span> <span class="s1">&#39;Intersection&#39;</span> <span class="c1"># todo</span>
<span class="nx">monadic</span> <span class="s1">&#39;∼&#39;</span><span class="p">,</span> <span class="s1">&#39;Not&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(x) -&gt;</span> <span class="o">+!</span><span class="nx">bool</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
<span class="nx">dyadic</span> <span class="s1">&#39;∼&#39;</span><span class="p">,</span> <span class="s1">&#39;Without&#39;</span><span class="p">,</span> <span class="nf">(b, a) -&gt;</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="nv">a = </span><span class="p">[</span><span class="nx">a</span><span class="p">]</span>
  <span class="k">else</span> <span class="nx">assert</span> <span class="nx">shapeOf</span><span class="p">(</span><span class="nx">a</span><span class="p">).</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Left argument to ∼ must be of rank no more than 1.&#39;</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">b</span> <span class="k">then</span> <span class="nv">b = </span><span class="p">[</span><span class="nx">b</span><span class="p">]</span>
  <span class="nv">r = </span><span class="p">[]</span>
  <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span>
    <span class="nv">excluded = </span><span class="kc">false</span>
    <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="nx">b</span>
      <span class="k">if</span> <span class="nx">match</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span>
        <span class="nv">excluded = </span><span class="kc">true</span>
        <span class="k">break</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">excluded</span>
      <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">x</span>
  <span class="nx">r</span>

<span class="nx">dyadic</span> <span class="s1">&#39;∨&#39;</span><span class="p">,</span> <span class="s1">&#39;Or&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(y, x) -&gt;</span>
  <span class="nv">x = </span><span class="nx">abs</span> <span class="nx">num</span> <span class="nx">x</span>
  <span class="nv">y = </span><span class="nx">abs</span> <span class="nx">num</span> <span class="nx">y</span>
  <span class="nx">assert</span> <span class="nx">x</span> <span class="o">is</span> <span class="nx">floor</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">and</span> <span class="nx">y</span> <span class="o">is</span> <span class="nx">floor</span><span class="p">(</span><span class="nx">y</span><span class="p">),</span> <span class="s1">&#39;∨ is defined only for integers&#39;</span>
  <span class="k">if</span> <span class="nx">x</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">y</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span>
  <span class="k">if</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">y</span> <span class="k">then</span> <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="p">]</span>
  <span class="k">while</span> <span class="nx">y</span> <span class="k">then</span> <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span> <span class="o">%</span> <span class="nx">y</span><span class="p">]</span> <span class="c1"># Euclid&#39;s algorithm</span>
  <span class="nx">x</span>

<span class="nx">dyadic</span> <span class="s1">&#39;∧&#39;</span><span class="p">,</span> <span class="s1">&#39;And&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(y, x) -&gt;</span>
  <span class="nv">x = </span><span class="nx">abs</span> <span class="nx">num</span> <span class="nx">x</span>
  <span class="nv">y = </span><span class="nx">abs</span> <span class="nx">num</span> <span class="nx">y</span>
  <span class="nx">assert</span> <span class="nx">x</span> <span class="o">is</span> <span class="nx">floor</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">and</span> <span class="nx">y</span> <span class="o">is</span> <span class="nx">floor</span><span class="p">(</span><span class="nx">y</span><span class="p">),</span> <span class="s1">&#39;∧ is defined only for integers&#39;</span>
  <span class="k">if</span> <span class="nx">x</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">or</span> <span class="nx">y</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span>
  <span class="nv">p = </span><span class="nx">x</span> <span class="o">*</span> <span class="nx">y</span>
  <span class="k">if</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">y</span> <span class="k">then</span> <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="p">]</span>
  <span class="k">while</span> <span class="nx">y</span> <span class="k">then</span> <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span> <span class="o">%</span> <span class="nx">y</span><span class="p">]</span> <span class="c1"># Euclid&#39;s algorithm</span>
  <span class="nx">p</span> <span class="sr">/ x # LCM(x, y) = x * y /</span> <span class="nx">GCD</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span>

<span class="nx">dyadic</span> <span class="s1">&#39;⍱&#39;</span><span class="p">,</span> <span class="s1">&#39;Nor&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(y, x) -&gt;</span> <span class="o">+!</span><span class="p">(</span><span class="nx">bool</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">or</span> <span class="nx">bool</span><span class="p">(</span><span class="nx">y</span><span class="p">))</span>
<span class="nx">dyadic</span> <span class="s1">&#39;⍲&#39;</span><span class="p">,</span> <span class="s1">&#39;Nand&#39;</span><span class="p">,</span> <span class="nx">pervasive</span> <span class="nf">(y, x) -&gt;</span> <span class="o">+!</span><span class="p">(</span><span class="nx">bool</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">and</span> <span class="nx">bool</span><span class="p">(</span><span class="nx">y</span><span class="p">))</span>

<span class="nx">monadic</span> <span class="s1">&#39;⍴&#39;</span><span class="p">,</span> <span class="s1">&#39;Shape of&#39;</span><span class="p">,</span> <span class="nx">shapeOf</span>
<span class="nx">dyadic</span> <span class="s1">&#39;⍴&#39;</span><span class="p">,</span> <span class="s1">&#39;Reshape&#39;</span><span class="p">,</span> <span class="nf">(b, a) -&gt;</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="nv">a = </span><span class="p">[</span><span class="nx">a</span><span class="p">]</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">b</span> <span class="k">then</span> <span class="nv">b = </span><span class="p">[</span><span class="nx">b</span><span class="p">]</span>
  <span class="nv">a =</span>
    <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span>
      <span class="nx">assert</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">is</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="s1">&#39;Domain error: Left argument to ⍴ must be a numeric scalar or vector.&#39;</span>
      <span class="nx">max</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">floor</span> <span class="nx">x</span>
  <span class="nx">withShape</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">withPrototypeCopiedFrom</span> <span class="nx">b</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">prod</span> <span class="nx">a</span><span class="p">]</span> <span class="k">then</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span> <span class="o">%</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Helper for functions <code>,</code> and <code>⍪</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">catenate = </span><span class="nf">(b, a, axis = -1) -&gt;</span>
  <span class="nv">sa = </span><span class="nx">shapeOf</span> <span class="nx">a</span><span class="p">;</span> <span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="nv">sa = </span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="nv">a = </span><span class="p">[</span><span class="nx">a</span><span class="p">]</span>
  <span class="nv">sb = </span><span class="nx">shapeOf</span> <span class="nx">b</span><span class="p">;</span> <span class="k">if</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="nv">sb = </span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="nv">b = </span><span class="p">[</span><span class="nx">b</span><span class="p">]</span>
  <span class="nx">assert</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s1">&#39;Length error: Cannot catenate arrays of different ranks&#39;</span>
  <span class="k">if</span> <span class="nx">axis</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">axis</span> <span class="o">+=</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">sa</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">when</span> <span class="nx">sa</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">isnt</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">and</span> <span class="nx">i</span> <span class="o">isnt</span> <span class="nx">axis</span>
    <span class="nx">die</span> <span class="s1">&#39;Length error: Catenated arrays must match at all axes except the one to catenate on&#39;</span>
  <span class="nv">ni = </span><span class="nx">prod</span> <span class="nx">sa</span><span class="p">[...</span><span class="nx">axis</span><span class="p">]</span>       <span class="c1"># number of items across all dimensions before `axis&#39;</span>
  <span class="nv">nja = </span><span class="nx">sa</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span>              <span class="c1"># number of items across `axis&#39; in `a&#39;</span>
  <span class="nv">njb = </span><span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span>              <span class="c1"># number of items across `axis&#39; in `b&#39;</span>
  <span class="nv">nk = </span><span class="nx">prod</span> <span class="nx">sa</span><span class="p">[</span><span class="nx">axis</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">...]</span>  <span class="c1"># number of items across all dimensions after `axis&#39;</span>
  <span class="nv">r = </span><span class="p">[]</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">ni</span><span class="p">]</span>
    <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">nja</span><span class="p">]</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">nk</span><span class="p">]</span> <span class="k">then</span> <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">a</span><span class="p">[</span><span class="nx">k</span> <span class="o">+</span> <span class="nx">nk</span> <span class="o">*</span> <span class="p">(</span><span class="nx">j</span> <span class="o">+</span> <span class="nx">nja</span> <span class="o">*</span> <span class="nx">i</span><span class="p">)]</span>
    <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">njb</span><span class="p">]</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">nk</span><span class="p">]</span> <span class="k">then</span> <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">b</span><span class="p">[</span><span class="nx">k</span> <span class="o">+</span> <span class="nx">nk</span> <span class="o">*</span> <span class="p">(</span><span class="nx">j</span> <span class="o">+</span> <span class="nx">njb</span> <span class="o">*</span> <span class="nx">i</span><span class="p">)]</span>
  <span class="nv">sr = </span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">sa</span> <span class="k">then</span> <span class="nx">x</span>
  <span class="nx">sr</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span>
  <span class="nx">withShape</span> <span class="nx">sr</span><span class="p">,</span> <span class="nx">r</span>

<span class="nx">monadic</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;Ravel&#39;</span><span class="p">,</span> <span class="nf">(a) -&gt;</span> <span class="nx">array</span><span class="p">(</span><span class="nx">a</span><span class="p">)[</span><span class="mi">0</span><span class="p">...]</span>
<span class="nx">dyadic</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;Catenate&#39;</span><span class="p">,</span> <span class="nx">catenate</span>
<span class="nx">dyadic</span> <span class="s1">&#39;⍪&#39;</span><span class="p">,</span> <span class="s1">&#39;1st axis catenate&#39;</span><span class="p">,</span> <span class="nf">(b, a) -&gt;</span> <span class="nx">catenate</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="mi">0</span>

<span class="nx">monadic</span> <span class="s1">&#39;⌽&#39;</span><span class="p">,</span> <span class="s1">&#39;Reverse&#39;</span><span class="p">,</span> <span class="nv">reverse = </span><span class="nf">(b, _1, axis = -1) -&gt;</span>
  <span class="nv">sb = </span><span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="k">if</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">b</span>
  <span class="k">if</span> <span class="nx">axis</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">axis</span> <span class="o">+=</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span>
  <span class="nx">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">axis</span> <span class="o">&lt;</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s1">&#39;Axis out of bounds&#39;</span>
  <span class="nv">ni = </span><span class="nx">prod</span> <span class="nx">sb</span><span class="p">[...</span><span class="nx">axis</span><span class="p">]</span>
  <span class="nv">nj = </span><span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span>
  <span class="nv">nk = </span><span class="nx">prod</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">...]</span>
  <span class="nv">r = </span><span class="p">[]</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">ni</span><span class="p">]</span>
    <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="nx">nj</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">..</span> <span class="mi">0</span><span class="p">]</span> <span class="k">by</span> <span class="o">-</span><span class="mi">1</span>
      <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">nk</span><span class="p">]</span>
        <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">b</span><span class="p">[</span><span class="nx">k</span> <span class="o">+</span> <span class="nx">nk</span><span class="o">*</span><span class="p">(</span><span class="nx">j</span> <span class="o">+</span> <span class="nx">nj</span><span class="o">*</span><span class="nx">i</span><span class="p">)]</span>
  <span class="nx">withShape</span> <span class="nx">sb</span><span class="p">,</span> <span class="nx">r</span>

<span class="nx">dyadic</span> <span class="s1">&#39;⌽&#39;</span><span class="p">,</span> <span class="s1">&#39;Rotate&#39;</span><span class="p">,</span> <span class="nf">(b, a) -&gt;</span>
  <span class="nv">a = </span><span class="nx">num</span> <span class="nx">a</span>
  <span class="k">if</span> <span class="nx">a</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">or</span> <span class="nx">isSimple</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">b</span>
  <span class="nv">sb = </span><span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="nv">n = </span><span class="nx">sb</span><span class="p">[</span><span class="nx">sb</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
  <span class="nx">a</span> <span class="o">%=</span> <span class="nx">n</span><span class="p">;</span> <span class="k">if</span> <span class="nx">a</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">a</span> <span class="o">+=</span> <span class="nx">n</span>
  <span class="nx">withShape</span> <span class="nx">sb</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="p">(</span><span class="nx">i</span> <span class="o">%</span> <span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="nx">i</span> <span class="o">%</span> <span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="nx">a</span><span class="p">)</span> <span class="o">%</span> <span class="nx">n</span><span class="p">])</span>

<span class="nx">monadic</span> <span class="s1">&#39;⊖&#39;</span><span class="p">,</span> <span class="s1">&#39;1st axis reverse&#39;</span><span class="p">,</span> <span class="nf">(b, _1, axis = 0) -&gt;</span> <span class="nx">reverse</span> <span class="nx">b</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">axis</span>

<span class="nx">dyadic</span> <span class="s1">&#39;⊖&#39;</span><span class="p">,</span> <span class="s1">&#39;1st axis rotate&#39;</span><span class="p">,</span> <span class="nf">(b, a) -&gt;</span>
  <span class="nv">a = </span><span class="nx">num</span> <span class="nx">a</span>
  <span class="k">if</span> <span class="nx">a</span> <span class="o">is</span> <span class="mi">0</span> <span class="o">or</span> <span class="nx">isSimple</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">b</span>
  <span class="nv">sb = </span><span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="nv">n = </span><span class="nx">sb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nv">k = </span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="err">/ n</span>
  <span class="nx">a</span> <span class="o">%=</span> <span class="nx">n</span><span class="p">;</span> <span class="k">if</span> <span class="nx">a</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">a</span> <span class="o">+=</span> <span class="nx">n</span>
  <span class="nx">withShape</span> <span class="nx">sb</span><span class="p">,</span> <span class="p">(</span><span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="nx">b</span><span class="p">[((</span><span class="nx">floor</span><span class="p">(</span><span class="nx">i</span> <span class="err">/ k) + a) % n) * k + (i % k)])</span>

<span class="nx">monadic</span> <span class="s1">&#39;⍉&#39;</span><span class="p">,</span> <span class="s1">&#39;Transpose&#39;</span><span class="p">,</span> <span class="nf">(a) -&gt;</span>
  <span class="nv">sa = </span><span class="nx">shapeOf</span> <span class="nx">a</span>
  <span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">a</span> <span class="c1"># has no effect on scalars or vectors</span>
  <span class="nv">sr = </span><span class="nx">sa</span><span class="p">[</span><span class="mi">0</span><span class="p">...].</span><span class="nx">reverse</span><span class="p">()</span>
  <span class="nv">psr = </span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># partial products over sr</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">then</span> <span class="nx">psr</span><span class="p">.</span><span class="nx">push</span> <span class="nx">psr</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">*</span> <span class="nx">sr</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
  <span class="nv">r = </span><span class="p">[]</span>
  <span class="nv">rec = </span><span class="nf">(d, i) -&gt;</span>
    <span class="k">if</span> <span class="nx">d</span> <span class="o">&gt;=</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="k">else</span> <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">sr</span><span class="p">[</span><span class="nx">d</span><span class="p">]]</span> <span class="k">then</span> <span class="nx">rec</span> <span class="nx">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">j</span><span class="o">*</span><span class="nx">psr</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span>
    <span class="mi">0</span>
  <span class="nx">rec</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
  <span class="nx">withShape</span> <span class="nx">sr</span><span class="p">,</span> <span class="nx">r</span>

<span class="nx">monadic</span> <span class="s1">&#39;↑&#39;</span><span class="p">,</span> <span class="s1">&#39;First&#39;</span><span class="p">,</span> <span class="nf">(a) -&gt;</span>
  <span class="nv">a = </span><span class="nx">array</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="nx">prototypeOf</span> <span class="nx">a</span>

<span class="nx">dyadic</span> <span class="s1">&#39;↑&#39;</span><span class="p">,</span> <span class="s1">&#39;Take&#39;</span><span class="p">,</span> <span class="nf">(b, a) -&gt;</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="nv">a = </span><span class="p">[</span><span class="nx">a</span><span class="p">]</span>
  <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span>
    <span class="nx">assert</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">is</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="s1">&#39;Domain error: Left argument to ↑ must be a numeric scalar or vector.&#39;</span>
  <span class="k">if</span> <span class="nx">isSimple</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">and</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="nv">b = </span><span class="p">[</span><span class="nx">b</span><span class="p">]</span>
  <span class="nv">sb = </span><span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="nx">assert</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s1">&#39;Length error: Left argument to ↑ must have as many elements as is the rank of its right argument.&#39;</span>
  <span class="nv">r = </span><span class="p">[]</span>
  <span class="nv">pa = </span><span class="k">for</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="mi">0</span>
  <span class="nx">pa</span><span class="p">[</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="nv">i = </span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="k">while</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">pa</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pa</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span> <span class="nx">i</span><span class="o">--</span>
  <span class="nv">filler = </span><span class="nx">prototypeOf</span> <span class="nx">b</span>
  <span class="nv">rec = </span><span class="nf">(d, i, k) -&gt;</span>
    <span class="k">if</span> <span class="nx">d</span> <span class="o">&gt;=</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="nx">k</span> <span class="err">/= sb[d]</span>
      <span class="k">if</span> <span class="nx">a</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">min</span> <span class="nx">a</span><span class="p">[</span><span class="nx">d</span><span class="p">],</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">]]</span> <span class="k">then</span> <span class="nx">rec</span> <span class="nx">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">j</span> <span class="o">*</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">k</span>
        <span class="k">if</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">a</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span>
          <span class="k">for</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">-</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">])</span> <span class="o">*</span> <span class="nx">pa</span><span class="p">[</span><span class="nx">d</span><span class="p">]]</span> <span class="k">then</span> <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">filler</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">+</span> <span class="nx">a</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span>
          <span class="k">for</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="o">-</span><span class="p">(</span><span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">+</span> <span class="nx">a</span><span class="p">[</span><span class="nx">d</span><span class="p">])</span> <span class="o">*</span> <span class="nx">pa</span><span class="p">[</span><span class="nx">d</span><span class="p">]]</span> <span class="k">then</span> <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">filler</span>
        <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">+</span> <span class="nx">a</span><span class="p">[</span><span class="nx">d</span><span class="p">])</span> <span class="p">...</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">]]</span> <span class="k">then</span> <span class="nx">rec</span> <span class="nx">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">j</span> <span class="o">*</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">k</span>
    <span class="mi">0</span>
  <span class="nx">rec</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span>
  <span class="nx">withShape</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">withPrototype</span> <span class="nx">filler</span><span class="p">,</span> <span class="nx">r</span>

<span class="nx">dyadic</span> <span class="s1">&#39;↓&#39;</span><span class="p">,</span> <span class="s1">&#39;Drop&#39;</span><span class="p">,</span> <span class="nf">(b, a) -&gt;</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="nv">a = </span><span class="p">[</span><span class="nx">a</span><span class="p">]</span>
  <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">when</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">isnt</span> <span class="s1">&#39;number&#39;</span> <span class="o">or</span> <span class="nx">x</span> <span class="o">isnt</span> <span class="nx">floor</span> <span class="nx">x</span>
    <span class="nx">die</span> <span class="s1">&#39;Left argument to ↓ must be an integer or a vector of integers.&#39;</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">b</span> <span class="k">then</span> <span class="nv">b = </span><span class="nx">withShape</span> <span class="p">(</span><span class="k">for</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="mi">1</span><span class="p">),</span> <span class="nx">b</span>
  <span class="nv">sb = </span><span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">die</span> <span class="s1">&#39;The left argument to ↓ must have length less than or equal to the rank of its right argument.&#39;</span>
  <span class="k">for</span> <span class="p">[</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">...</span><span class="nx">sb</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="nx">a</span><span class="p">.</span><span class="nx">push</span> <span class="mi">0</span>
  <span class="nv">lims =</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="p">[</span><span class="nx">min</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">i</span><span class="p">]),</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span>
      <span class="k">else</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">])]</span>
  <span class="nv">r = </span><span class="p">[]</span>
  <span class="nv">rec = </span><span class="nf">(d, i, n) -&gt;</span>
    <span class="k">if</span> <span class="nx">d</span> <span class="o">&gt;=</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="nx">n</span> <span class="err">/= sb[d]</span>
      <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="nx">lims</span><span class="p">[</span><span class="nx">d</span><span class="p">][</span><span class="mi">0</span><span class="p">]...</span><span class="nx">lims</span><span class="p">[</span><span class="nx">d</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span>
        <span class="nx">rec</span> <span class="nx">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">j</span><span class="o">*</span><span class="nx">n</span><span class="p">,</span> <span class="nx">n</span>
    <span class="mi">0</span>
  <span class="nx">rec</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span>
  <span class="nv">sr = </span><span class="k">for</span> <span class="p">[</span><span class="nx">lo</span><span class="p">,</span> <span class="nx">hi</span><span class="p">]</span> <span class="k">in</span> <span class="nx">lims</span> <span class="k">then</span> <span class="nx">hi</span> <span class="o">-</span> <span class="nx">lo</span>
  <span class="nx">withShape</span> <span class="nx">sr</span><span class="p">,</span> <span class="nx">r</span>

<span class="nx">monadic</span> <span class="s1">&#39;⊂&#39;</span><span class="p">,</span> <span class="s1">&#39;Enclose&#39;</span><span class="p">,</span> <span class="nf">(a) -&gt;</span> <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="nx">a</span> <span class="k">else</span> <span class="nx">withShape</span> <span class="p">[],</span> <span class="p">[</span><span class="nx">a</span><span class="p">]</span>
<span class="nx">dyadic</span> <span class="s1">&#39;⊂&#39;</span><span class="p">,</span> <span class="s1">&#39;Partition (with axis)&#39;</span> <span class="c1"># todo</span>

<span class="nx">monadic</span> <span class="s1">&#39;⊃&#39;</span><span class="p">,</span> <span class="s1">&#39;Disclose&#39;</span><span class="p">,</span> <span class="nf">(a) -&gt;</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">a</span>
  <span class="nv">sa = </span><span class="nx">shapeOf</span> <span class="nx">a</span>
  <span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nv">sr1 = </span><span class="nx">shapeOf</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">...]</span>
  <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">...]</span>
    <span class="nv">sx = </span><span class="nx">shapeOf</span> <span class="nx">x</span>
    <span class="k">if</span> <span class="nx">sx</span><span class="p">.</span><span class="nx">length</span> <span class="o">isnt</span> <span class="nx">sr1</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">die</span> <span class="s1">&#39;The argument of ⊃ must contain elements of the same rank.&#39;</span> <span class="c1"># todo: or scalars</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">sr1</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
      <span class="nx">sr1</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">max</span> <span class="nx">sr1</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">sx</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
  <span class="nv">sr = </span><span class="nx">shapeOf</span><span class="p">(</span><span class="nx">a</span><span class="p">).</span><span class="nx">concat</span> <span class="nx">sr1</span>
  <span class="nv">r = </span><span class="p">[]</span>
  <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span>
    <span class="nv">sx = </span><span class="nx">shapeOf</span> <span class="nx">x</span>
    <span class="nv">rec = </span><span class="nf">(d, i, n, N) -&gt;</span> <span class="c1"># d: dimension, i: index in x, n: block size in x, N: block size in r</span>
      <span class="k">if</span> <span class="nx">d</span> <span class="o">&gt;=</span> <span class="nx">sr1</span><span class="p">.</span><span class="nx">length</span>
        <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">x</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="nx">n</span> <span class="err">/= sx[d]</span>
        <span class="nx">N</span> <span class="err">/= sr1[d]</span>
        <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">sx</span><span class="p">[</span><span class="nx">d</span><span class="p">]]</span>
          <span class="nx">rec</span> <span class="nx">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">j</span> <span class="o">*</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">N</span>
        <span class="k">if</span> <span class="nx">sr1</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">sx</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span>
          <span class="nv">filler = </span><span class="nx">prototypeOf</span> <span class="nx">x</span>
          <span class="k">for</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">N</span> <span class="o">*</span> <span class="p">(</span><span class="nx">sr1</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="o">-</span> <span class="nx">sx</span><span class="p">[</span><span class="nx">d</span><span class="p">])]</span>
            <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">filler</span>
    <span class="nx">rec</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">prod</span> <span class="nx">sr1</span>
  <span class="nx">withShape</span> <span class="nx">sr</span><span class="p">,</span> <span class="nx">r</span>

<span class="nx">dyadic</span> <span class="s1">&#39;⊃&#39;</span><span class="p">,</span> <span class="s1">&#39;Pick&#39;</span>

<span class="nx">dyadic</span> <span class="s1">&#39;⌷&#39;</span><span class="p">,</span> <span class="s1">&#39;Index&#39;</span><span class="p">,</span> <span class="nf">(b, a) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p><code>(a0 a1 ...)⌷b</code> is equivalent to <code>b[a0;a1;...]</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="nv">a = </span><span class="p">[</span><span class="nx">a</span><span class="p">]</span>
  <span class="nx">assert</span> <span class="p">(</span><span class="o">not</span> <span class="nx">a</span><span class="p">.</span><span class="nx">shape</span><span class="p">)</span> <span class="o">or</span> <span class="nx">a</span><span class="p">.</span><span class="nx">shape</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Indices must be a scalar or a vector, not a higher-dimensional array.&#39;</span>
  <span class="nv">sb = </span><span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">b</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span> <span class="k">then</span> <span class="k">return</span> <span class="nf">(y, x) -&gt;</span> <span class="nx">b</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">a</span>
  <span class="nx">assert</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s1">&#39;The number of indices must be equal to the rank of the indexable.&#39;</span>
  <span class="nv">a = </span><span class="k">for</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">a</span>
        <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">x</span> <span class="k">then</span> <span class="nx">withShape</span> <span class="p">[],</span> <span class="p">[</span><span class="nx">x</span><span class="p">]</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">sb</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span>
        <span class="k">else</span> <span class="nx">x</span>
  <span class="k">for</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">d</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="nx">x</span> <span class="k">when</span> <span class="o">not</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">y</span> <span class="o">is</span> <span class="s1">&#39;number&#39;</span> <span class="o">and</span> <span class="nx">y</span> <span class="o">is</span> <span class="nx">floor</span><span class="p">(</span><span class="nx">y</span><span class="p">))</span>
    <span class="nx">die</span> <span class="s1">&#39;Indices must be integers&#39;</span>
  <span class="k">for</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">d</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="nx">x</span> <span class="k">when</span> <span class="o">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">])</span>
    <span class="nx">die</span> <span class="s1">&#39;Index out of bounds&#39;</span>
  <span class="nv">sr = </span><span class="p">[];</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">then</span> <span class="nv">sr = </span><span class="nx">sr</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">shapeOf</span> <span class="nx">x</span>
  <span class="nv">r = </span><span class="p">[]</span>
  <span class="nv">rec = </span><span class="nf">(d, i, n) -&gt;</span>
    <span class="k">if</span> <span class="nx">d</span> <span class="o">&gt;=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="k">else</span> <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span> <span class="k">then</span> <span class="nx">rec</span> <span class="nx">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">n</span> <span class="sr">/ sb[d]), n /</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">d</span><span class="p">]</span>
    <span class="mi">0</span>
  <span class="nx">rec</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span>
  <span class="k">if</span> <span class="nx">sr</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="nx">withShape</span> <span class="nx">sr</span><span class="p">,</span> <span class="nx">r</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Helper for <code>⍋</code> and <code>⍒</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">grade = </span><span class="nf">(b, a, direction) -&gt;</span>
  <span class="k">if</span> <span class="o">not</span> <span class="nx">a</span><span class="o">?</span> <span class="k">then</span> <span class="nv">a = </span><span class="p">[]</span>
  <span class="nv">sa = </span><span class="nx">shapeOf</span> <span class="nx">a</span>
  <span class="nv">sb = </span><span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="nx">assert</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s1">&#39;Left argument to ⍋ or ⍒ must be non-scalar.&#39;</span>
  <span class="k">if</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">b</span>
  <span class="nv">n = </span><span class="nx">sa</span><span class="p">[</span><span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="c1"># length along last axis</span>
  <span class="nv">h = </span><span class="p">{}</span> <span class="c1"># maps a character to its index in the collation</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="nx">h</span><span class="p">[</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">%</span> <span class="nx">n</span>
  <span class="nv">m = </span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="err">/ sb[0]</span>
  <span class="nv">r = </span><span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">sb</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
  <span class="nx">r</span><span class="p">.</span><span class="nx">sort</span> <span class="nf">(i, j) -&gt;</span>
    <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">m</span><span class="p">]</span>
      <span class="nv">x = </span><span class="nx">b</span><span class="p">[</span><span class="nx">m</span><span class="o">*</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">k</span><span class="p">]</span>
      <span class="nv">y = </span><span class="nx">b</span><span class="p">[</span><span class="nx">m</span><span class="o">*</span><span class="nx">j</span> <span class="o">+</span> <span class="nx">k</span><span class="p">]</span>
      <span class="nv">tx = </span><span class="k">typeof</span> <span class="nx">x</span>
      <span class="nv">ty = </span><span class="k">typeof</span> <span class="nx">y</span>
      <span class="k">if</span> <span class="nx">tx</span> <span class="o">&lt;</span> <span class="nx">ty</span> <span class="k">then</span> <span class="k">return</span> <span class="o">-</span><span class="nx">direction</span>
      <span class="k">if</span> <span class="nx">tx</span> <span class="o">&gt;</span> <span class="nx">ty</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">direction</span>
      <span class="k">if</span> <span class="nx">h</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span><span class="o">?</span> <span class="k">then</span> <span class="nv">x = </span><span class="nx">h</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">h</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span><span class="o">?</span> <span class="k">then</span> <span class="nv">y = </span><span class="nx">h</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">y</span> <span class="k">then</span> <span class="k">return</span> <span class="o">-</span><span class="nx">direction</span>
      <span class="k">if</span> <span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">y</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">direction</span>
    <span class="mi">0</span>
  <span class="nx">r</span>

<span class="nx">monadic</span> <span class="s1">&#39;⍋&#39;</span><span class="p">,</span> <span class="s1">&#39;Grade up&#39;</span><span class="p">,</span> <span class="nf">(b, a) -&gt;</span> <span class="nx">grade</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="mi">1</span>
<span class="nx">monadic</span> <span class="s1">&#39;⍒&#39;</span><span class="p">,</span> <span class="s1">&#39;Grade down&#39;</span><span class="p">,</span> <span class="nf">(b, a) -&gt;</span> <span class="nx">grade</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>

<span class="nx">monadic</span> <span class="s1">&#39;⊤&#39;</span><span class="p">,</span> <span class="s1">&#39;Encode&#39;</span><span class="p">,</span> <span class="nf">(b, a) -&gt;</span>
  <span class="nv">sa = </span><span class="nx">shapeOf</span> <span class="nx">a</span>
  <span class="nv">sb = </span><span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="nv">a = </span><span class="p">[</span><span class="nx">a</span><span class="p">]</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">b</span> <span class="k">then</span> <span class="nv">b = </span><span class="p">[</span><span class="nx">b</span><span class="p">]</span>
  <span class="nv">r = </span><span class="nb">Array</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span>
  <span class="nv">n = </span><span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="nx">sa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="mi">1</span>
  <span class="nv">m = </span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="err">/ n</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">m</span><span class="p">]</span>
    <span class="k">for</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">j</span> <span class="k">in</span> <span class="nx">b</span>
      <span class="k">if</span> <span class="nv">isNeg = </span><span class="p">(</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span> <span class="nv">y = </span><span class="o">-</span><span class="nx">y</span>
      <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">..</span> <span class="mi">0</span><span class="p">]</span> <span class="k">by</span> <span class="o">-</span><span class="mi">1</span>
        <span class="nv">x = </span><span class="nx">a</span><span class="p">[</span><span class="nx">k</span> <span class="o">*</span> <span class="nx">m</span> <span class="o">+</span> <span class="nx">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">x</span> <span class="o">is</span> <span class="mi">0</span>
          <span class="nx">r</span><span class="p">[(</span><span class="nx">k</span> <span class="o">*</span> <span class="nx">m</span> <span class="o">+</span> <span class="nx">i</span><span class="p">)</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">y</span>
          <span class="nv">y = </span><span class="mi">0</span>
        <span class="k">else</span>
          <span class="nx">r</span><span class="p">[(</span><span class="nx">k</span> <span class="o">*</span> <span class="nx">m</span> <span class="o">+</span> <span class="nx">i</span><span class="p">)</span> <span class="o">*</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">y</span> <span class="o">%</span> <span class="nx">x</span>
          <span class="nv">y = </span><span class="nx">round</span><span class="p">((</span><span class="nx">y</span> <span class="o">-</span> <span class="p">(</span><span class="nx">y</span> <span class="o">%</span> <span class="nx">x</span><span class="p">))</span> <span class="o">/</span> <span class="nx">x</span><span class="p">)</span>
  <span class="nx">withShape</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">sb</span><span class="p">),</span> <span class="nx">r</span>

<span class="nx">monadic</span> <span class="s1">&#39;⊥&#39;</span><span class="p">,</span> <span class="s1">&#39;Decode&#39;</span><span class="p">,</span> <span class="nf">(b, a) -&gt;</span>
  <span class="nv">sa = </span><span class="nx">shapeOf</span> <span class="nx">a</span>
  <span class="nv">sb = </span><span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="nv">lastDimA = </span><span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="nx">sa</span><span class="p">[</span><span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="mi">1</span>
  <span class="nv">firstDimB = </span><span class="k">if</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="nx">sb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="mi">1</span>
  <span class="nx">assert</span> <span class="nx">lastDimA</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">or</span> <span class="nx">firstDimB</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">or</span> <span class="nx">lastDimA</span> <span class="o">is</span> <span class="nx">firstDimB</span><span class="p">,</span> <span class="s1">&#39;Incompatible shapes for ⊥ (&quot;Decode&quot;)&#39;</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="nv">a = </span><span class="p">[</span><span class="nx">a</span><span class="p">]</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">b</span> <span class="k">then</span> <span class="nv">b = </span><span class="p">[</span><span class="nx">b</span><span class="p">]</span>
  <span class="nv">r = </span><span class="p">[]</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="err">/ lastDimA]</span>
    <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="err">/ firstDimB]</span>
      <span class="nv">x = </span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span> <span class="o">*</span> <span class="nx">lastDimA</span> <span class="p">...</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">lastDimA</span><span class="p">]</span>
      <span class="nv">y = </span><span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">firstDimB</span><span class="p">]</span> <span class="k">then</span> <span class="nx">b</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="nx">k</span> <span class="o">*</span> <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="err">/ firstDimB)]</span>
      <span class="k">if</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="nv">x = </span><span class="k">for</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">y</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">y</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="nv">y = </span><span class="k">for</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">x</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="nx">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nv">z = </span><span class="nx">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">...</span><span class="nx">y</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
        <span class="nv">z = </span><span class="nx">z</span> <span class="o">*</span> <span class="nx">x</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">+</span> <span class="nx">y</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
      <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">z</span>
  <span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">1</span>
    <span class="nx">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">else</span>
    <span class="nx">withShape</span> <span class="nx">sa</span><span class="p">[...</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">sb</span><span class="p">[</span><span class="mi">1</span><span class="p">...]),</span> <span class="nx">r</span>

<span class="nx">monadic</span> <span class="s1">&#39;⍕&#39;</span><span class="p">,</span> <span class="s1">&#39;Format&#39;</span>
<span class="nx">dyadic</span> <span class="s1">&#39;⍕&#39;</span><span class="p">,</span> <span class="s1">&#39;Format by example or specification&#39;</span>
<span class="nx">monadic</span> <span class="s1">&#39;⍎&#39;</span><span class="p">,</span> <span class="s1">&#39;Execute&#39;</span>
<span class="nx">monadic</span> <span class="s1">&#39;⊣&#39;</span><span class="p">,</span> <span class="s1">&#39;Stop&#39;</span>
<span class="nx">dyadic</span> <span class="s1">&#39;⊣&#39;</span><span class="p">,</span> <span class="s1">&#39;Left&#39;</span>
<span class="nx">monadic</span> <span class="s1">&#39;⊢&#39;</span><span class="p">,</span> <span class="s1">&#39;Pass&#39;</span>
<span class="nx">dyadic</span> <span class="s1">&#39;⊢&#39;</span><span class="p">,</span> <span class="s1">&#39;Right&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p><code>⍬</code> Zilde (niladic function)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">builtins</span><span class="p">[</span><span class="s1">&#39;⍬&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h1>Built-in operators</h1>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Helper for / and ⌿ in their operator sense</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">reduce = </span><span class="nf">(f, _, axis = -1) -&gt;</span> <span class="nf">(b, a) -&gt;</span>
  <span class="nv">invokedAsMonadic = </span><span class="o">not</span> <span class="nx">a</span><span class="o">?</span>
  <span class="k">if</span> <span class="nx">invokedAsMonadic</span> <span class="k">then</span> <span class="nv">a = </span><span class="mi">0</span>
  <span class="nv">a = </span><span class="nx">floor</span> <span class="nx">num</span> <span class="nx">a</span>
  <span class="nv">isBackwards = </span><span class="nx">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span> <span class="k">if</span> <span class="nx">isBackwards</span> <span class="k">then</span> <span class="nv">a = </span><span class="o">-</span><span class="nx">a</span>
  <span class="nv">b = </span><span class="nx">array</span> <span class="nx">b</span>
  <span class="nv">sb = </span><span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="k">if</span> <span class="nx">axis</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">axis</span> <span class="o">+=</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span>
  <span class="nv">n = </span><span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span>
  <span class="k">if</span> <span class="nx">a</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="nv">a = </span><span class="nx">n</span>
  <span class="k">if</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span>
    <span class="nv">items = </span><span class="nx">b</span>
  <span class="k">else</span>
    <span class="nv">sItem = </span><span class="nx">sb</span><span class="p">[...</span><span class="nx">axis</span><span class="p">].</span><span class="nx">concat</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">...]</span> <span class="c1"># shape of an item</span>
    <span class="nv">k = </span><span class="nx">prod</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">...]</span>
    <span class="nv">items = </span><span class="k">for</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">n</span><span class="p">]</span> <span class="k">then</span> <span class="nx">withShape</span> <span class="nx">sItem</span><span class="p">,</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="nx">items</span><span class="p">[</span><span class="nx">floor</span><span class="p">(</span><span class="nx">i</span> <span class="err">/ k) % n].push b[i]</span>
  <span class="nv">r =</span>
    <span class="k">if</span> <span class="nx">isBackwards</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">n</span> <span class="o">-</span> <span class="nx">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="nv">x = </span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">a</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span> <span class="p">(</span><span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">a</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">...</span> <span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">by</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="nv">x = </span><span class="nx">f</span> <span class="nx">items</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">x</span><span class="p">);</span> <span class="nx">x</span>
    <span class="k">else</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">n</span> <span class="o">-</span> <span class="nx">a</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="nv">x = </span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="p">(</span><span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">...</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">a</span><span class="p">]</span> <span class="k">by</span> <span class="mi">1</span> <span class="k">then</span> <span class="nv">x = </span><span class="nx">f</span> <span class="nx">items</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">x</span><span class="p">);</span> <span class="nx">x</span>
  <span class="k">if</span> <span class="nx">invokedAsMonadic</span> <span class="k">then</span> <span class="nx">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="nx">r</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Helper for / and ⌿ in their function sense</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">compressOrReplicate = </span><span class="nf">(b, a, axis = -1) -&gt;</span>
  <span class="nv">sb = </span><span class="nx">shapeOf</span> <span class="nx">b</span>
  <span class="k">if</span> <span class="nx">axis</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">axis</span> <span class="o">+=</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span>
  <span class="nx">assert</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">axis</span> <span class="o">&lt;</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s1">&#39;Axis out of bounds&#39;</span>
  <span class="nv">sr = </span><span class="nx">sb</span><span class="p">[</span><span class="mi">0</span><span class="p">...]</span>
  <span class="nx">sr</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="nx">assert</span> <span class="nx">shapeOf</span><span class="p">(</span><span class="nx">a</span><span class="p">).</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Left argument to / must be an integer or a vector of integers&#39;</span>
  <span class="k">if</span> <span class="o">not</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="nv">a = </span><span class="k">for</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span><span class="p">]]</span> <span class="k">then</span> <span class="nx">a</span>

  <span class="nv">nNonNegative = </span><span class="mi">0</span> <span class="c1"># number of non-negative elements in a</span>
  <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span>
    <span class="nx">assert</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">is</span> <span class="s1">&#39;number&#39;</span> <span class="o">and</span> <span class="nx">x</span> <span class="o">is</span> <span class="nx">floor</span> <span class="nx">x</span><span class="p">,</span> <span class="s1">&#39;Left argument to / must be an integer or a vector of integers&#39;</span>
    <span class="nx">sr</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">abs</span> <span class="nx">x</span>
    <span class="nx">nNonNegative</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>

  <span class="nv">isExtensive = </span><span class="kc">true</span><span class="p">;</span> <span class="nv">isExpansive = isHyperexpansive = </span><span class="kc">false</span>
  <span class="k">if</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span> <span class="o">isnt</span> <span class="mi">1</span>
    <span class="nv">isExtensive = </span><span class="kc">false</span>
    <span class="nv">isExpansive = </span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span>
    <span class="nv">isHyperexpansive = </span><span class="o">not</span> <span class="nx">isExpansive</span>
    <span class="nx">assert</span><span class="p">((</span><span class="o">not</span> <span class="nx">isHyperexpansive</span><span class="p">)</span> <span class="o">or</span> <span class="nx">nNonNegative</span> <span class="o">is</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span><span class="p">],</span>
      <span class="s1">&#39;For A/B, the length of B along the selected axis &#39;</span> <span class="o">+</span>
      <span class="s1">&#39;must be equal either to one, &#39;</span> <span class="o">+</span>                 <span class="c1"># extension</span>
      <span class="s1">&#39;or the length of A, &#39;</span> <span class="o">+</span>                          <span class="c1"># expansion</span>
      <span class="s1">&#39;or to the number of non-negative elements in A.&#39;</span> <span class="c1"># hyperexpansion</span>
    <span class="p">)</span>
  <span class="nv">r = </span><span class="p">[]</span>
  <span class="nv">ni = </span><span class="nx">prod</span> <span class="nx">sb</span><span class="p">[...</span> <span class="nx">axis</span><span class="p">]</span>
  <span class="nv">nj = </span><span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span>
  <span class="nv">nk = </span><span class="nx">prod</span> <span class="nx">sb</span><span class="p">[</span><span class="nx">axis</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">...]</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">ni</span><span class="p">]</span>
    <span class="nv">j = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span>
      <span class="k">if</span> <span class="nx">x</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">x</span><span class="p">]</span>
          <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">nk</span><span class="p">]</span>
            <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">b</span><span class="p">[</span><span class="nx">k</span> <span class="o">+</span> <span class="nx">nk</span><span class="o">*</span><span class="p">(</span><span class="nx">j</span> <span class="o">+</span> <span class="nx">nj</span><span class="o">*</span><span class="nx">i</span><span class="p">)]</span>
        <span class="nx">j</span> <span class="o">+=</span> <span class="nx">isExpansive</span> <span class="o">or</span> <span class="nx">isHyperexpansive</span>
      <span class="k">else</span>
        <span class="nv">filler = </span><span class="nx">prototypeOf</span><span class="p">(</span><span class="k">if</span> <span class="nx">isExpansive</span> <span class="k">then</span> <span class="p">[</span><span class="nx">b</span><span class="p">[</span><span class="nx">nk</span><span class="o">*</span><span class="p">(</span><span class="nx">j</span> <span class="o">+</span> <span class="nx">nj</span><span class="o">*</span><span class="nx">i</span><span class="p">)]]</span> <span class="k">else</span> <span class="p">[</span><span class="nx">b</span><span class="p">[</span><span class="nx">nk</span><span class="o">*</span><span class="nx">nj</span><span class="o">*</span><span class="nx">i</span><span class="p">]])</span>
        <span class="k">for</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="o">-</span><span class="nx">x</span><span class="o">*</span><span class="nx">nk</span><span class="p">]</span>
          <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">filler</span>
        <span class="nx">j</span> <span class="o">+=</span> <span class="nx">isExpansive</span>

  <span class="nx">withShape</span> <span class="nx">sr</span><span class="p">,</span> <span class="nx">r</span>

<span class="nx">postfixOperator</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;Reduce, compress, or replicate&#39;</span><span class="p">,</span> <span class="nf">(b, a, axis = -1) -&gt;</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">b</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
    <span class="nx">reduce</span> <span class="nx">b</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">axis</span>
  <span class="k">else</span>
    <span class="nx">compressOrReplicate</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">axis</span>

<span class="nx">postfixOperator</span> <span class="s1">&#39;⌿&#39;</span><span class="p">,</span> <span class="s1">&#39;1st axis reduce, compress, or replicate&#39;</span><span class="p">,</span> <span class="nf">(b, a, axis = 0) -&gt;</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">b</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
    <span class="nx">reduce</span> <span class="nx">b</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">axis</span>
  <span class="k">else</span>
    <span class="nx">compressOrReplicate</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">axis</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Helper for <code>\</code> and <code>⍀</code> in their operator sense</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">scan = </span><span class="nf">(f, _, axis = -1) -&gt;</span> <span class="nf">(a, _1) -&gt;</span>
  <span class="nx">assert</span> <span class="o">not</span> <span class="nx">_1</span><span class="o">?</span><span class="p">,</span> <span class="s1">&#39;Scan can only be applied monadically.&#39;</span>
  <span class="nv">sa = </span><span class="nx">shapeOf</span> <span class="nx">a</span>
  <span class="k">if</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">a</span>
  <span class="k">if</span> <span class="nx">axis</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">axis</span> <span class="o">+=</span> <span class="nx">sa</span><span class="p">.</span><span class="nx">length</span>
  <span class="nv">r = </span><span class="nb">Array</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span>
  <span class="nv">ni = </span><span class="nx">prod</span> <span class="nx">sa</span><span class="p">[...</span><span class="nx">axis</span><span class="p">]</span>
  <span class="nv">nj = </span><span class="nx">sa</span><span class="p">[</span><span class="nx">axis</span><span class="p">]</span>
  <span class="nv">nk = </span><span class="nx">prod</span> <span class="nx">sa</span><span class="p">[</span><span class="nx">axis</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">...]</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">ni</span><span class="p">]</span>
    <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">nk</span><span class="p">]</span>
      <span class="nv">x = </span><span class="nx">r</span><span class="p">[</span><span class="nx">k</span> <span class="o">+</span> <span class="nx">nk</span><span class="o">*</span><span class="nx">nj</span><span class="o">*</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">a</span><span class="p">[</span><span class="nx">k</span> <span class="o">+</span> <span class="nx">nk</span><span class="o">*</span><span class="nx">nj</span><span class="o">*</span><span class="nx">i</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">...</span><span class="nx">nj</span><span class="p">]</span>
        <span class="nv">ijk = </span><span class="nx">k</span> <span class="o">+</span> <span class="nx">nk</span> <span class="o">*</span> <span class="p">(</span><span class="nx">j</span> <span class="o">+</span> <span class="nx">nj</span> <span class="o">*</span> <span class="nx">i</span><span class="p">)</span>
        <span class="nv">x = </span><span class="nx">r</span><span class="p">[</span><span class="nx">ijk</span><span class="p">]</span> <span class="o">=</span> <span class="nx">f</span> <span class="nx">a</span><span class="p">[</span><span class="nx">ijk</span><span class="p">],</span> <span class="nx">x</span>
  <span class="nx">withShape</span> <span class="nx">shapeOf</span><span class="p">(</span><span class="nx">a</span><span class="p">),</span> <span class="nx">r</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Helper for <code>\</code> and <code>⍀</code> in their function sense</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">expand = </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>todo</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">postfixOperator</span> <span class="s1">&#39;\\&#39;</span><span class="p">,</span> <span class="s1">&#39;Scan or expand&#39;</span><span class="p">,</span> <span class="nf">(b, a, axis = -1) -&gt;</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">b</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
    <span class="nx">scan</span> <span class="nx">b</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">axis</span>
  <span class="k">else</span>
    <span class="nx">expand</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">axis</span>

<span class="nx">postfixOperator</span> <span class="s1">&#39;⍀&#39;</span><span class="p">,</span> <span class="s1">&#39;1st axis scan or expand&#39;</span><span class="p">,</span> <span class="nf">(b, a, axis = 0) -&gt;</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">b</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
    <span class="nx">scan</span> <span class="nx">b</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">axis</span>
  <span class="k">else</span>
    <span class="nx">expand</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">axis</span>

<span class="nx">postfixOperator</span> <span class="s1">&#39;¨&#39;</span><span class="p">,</span> <span class="s1">&#39;Each&#39;</span><span class="p">,</span> <span class="nf">(f) -&gt;</span> <span class="nf">(b, a) -&gt;</span>
  <span class="k">if</span> <span class="o">not</span> <span class="nx">a</span><span class="o">?</span> <span class="k">then</span> <span class="k">return</span> <span class="p">(</span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">array</span> <span class="nx">b</span> <span class="k">then</span> <span class="nx">f</span> <span class="nx">x</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">isSimple</span> <span class="nx">a</span> <span class="k">then</span> <span class="k">return</span> <span class="p">(</span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">array</span> <span class="nx">b</span> <span class="k">then</span> <span class="nx">f</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span>
  <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="k">return</span> <span class="p">(</span><span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span> <span class="k">then</span> <span class="nx">f</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
  <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">return</span> <span class="p">(</span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">b</span> <span class="k">then</span> <span class="nx">f</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">return</span> <span class="p">(</span><span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">then</span> <span class="nx">f</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">x</span><span class="p">)</span>
  <span class="nx">die</span> <span class="s1">&#39;Length error&#39;</span>

<span class="nx">prefixOperator</span> <span class="s1">&#39;∘.&#39;</span><span class="p">,</span> <span class="s1">&#39;Outer product&#39;</span><span class="p">,</span> <span class="nv">outerProduct = </span><span class="nf">(f) -&gt;</span>
  <span class="nx">assert</span> <span class="k">typeof</span> <span class="nx">f</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
  <span class="nf">(b, a) -&gt;</span>
    <span class="nx">assert</span> <span class="nx">a</span><span class="o">?</span><span class="p">,</span> <span class="s1">&#39;Operator ∘. (Outer product) works only with dyadic functions&#39;</span>
    <span class="nv">a = </span><span class="nx">array</span> <span class="nx">a</span>
    <span class="nv">b = </span><span class="nx">array</span> <span class="nx">b</span>
    <span class="nv">r = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">a</span> <span class="k">then</span> <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="nx">b</span> <span class="k">then</span> <span class="nx">r</span><span class="p">.</span><span class="nx">push</span> <span class="nx">f</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">x</span>
    <span class="nx">withShape</span> <span class="p">(</span><span class="nx">shapeOf</span> <span class="nx">a</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span><span class="nx">shapeOf</span> <span class="nx">b</span><span class="p">),</span> <span class="nx">r</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>todo: the general formula for higher dimensions is
<code>A f.g B   &lt;=&gt;   f/¨ (⊂[⍴⍴A]A)∘.g ⊂[1]B</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">infixOperator</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;Inner product&#39;</span><span class="p">,</span> <span class="nf">(g, f) -&gt;</span>
  <span class="nv">F = </span><span class="nx">reduce</span> <span class="nx">f</span>
  <span class="nf">(b, a) -&gt;</span>
    <span class="nx">assert</span> <span class="nx">shapeOf</span><span class="p">(</span><span class="nx">a</span><span class="p">).</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">shapeOf</span><span class="p">(</span><span class="nx">b</span><span class="p">).</span><span class="nx">length</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Inner product operator (.) is implemented only for arrays of rank no more than 1.&#39;</span>
    <span class="nx">F</span> <span class="nx">g</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">a</span>

<span class="nx">infixOperator</span> <span class="s1">&#39;⍣&#39;</span><span class="p">,</span> <span class="s1">&#39;Power operator&#39;</span><span class="p">,</span> <span class="nf">(f, n) -&gt;</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">f</span> <span class="o">is</span> <span class="s1">&#39;number&#39;</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">n</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span>
    <span class="p">[</span><span class="nx">f</span><span class="p">,</span> <span class="nx">n</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">n</span><span class="p">,</span> <span class="nx">f</span><span class="p">]</span>
  <span class="k">else</span>
    <span class="nx">assert</span> <span class="k">typeof</span> <span class="nx">f</span> <span class="o">is</span> <span class="s1">&#39;function&#39;</span> <span class="o">and</span> <span class="k">typeof</span> <span class="nx">n</span> <span class="o">is</span> <span class="s1">&#39;number&#39;</span>
  <span class="nf">(y, x) -&gt;</span>
    <span class="k">for</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">n</span><span class="p">]</span> <span class="k">then</span> <span class="nv">y = </span><span class="nx">f</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">x</span>
    <span class="nx">y</span>

<span class="nx">builtins</span><span class="p">[</span><span class="s1">&#39;set_⎕&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nf">(x) -&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">info</span> <span class="nx">x</span><span class="p">;</span> <span class="nx">x</span>

<span class="nv">builtins.aplify = </span><span class="nf">(x) -&gt;</span>
  <span class="nx">assert</span> <span class="nx">x</span> <span class="o">isnt</span> <span class="kc">null</span>
  <span class="nx">assert</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">isnt</span> <span class="s1">&#39;undefined&#39;</span>
  <span class="k">if</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">is</span> <span class="s1">&#39;string&#39;</span>
    <span class="nv">x = </span><span class="nx">withPrototype</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nx">x</span><span class="p">.</span><span class="nx">split</span> <span class="s1">&#39;&#39;</span>
  <span class="nx">x</span>

<span class="nx">endOfBuiltins</span><span class="p">()</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 