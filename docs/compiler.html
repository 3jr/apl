<!DOCTYPE html>

<html>
<head>
  <title>compiler.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="apl.html">
                apl.coffee
              </a>
            
              
              <a class="source" href="command.html">
                command.coffee
              </a>
            
              
              <a class="source" href="compiler.html">
                compiler.coffee
              </a>
            
              
              <a class="source" href="complex.html">
                complex.coffee
              </a>
            
              
              <a class="source" href="formatter.html">
                formatter.coffee
              </a>
            
              
              <a class="source" href="helpers.html">
                helpers.coffee
              </a>
            
              
              <a class="source" href="lexer.html">
                lexer.coffee
              </a>
            
              
              <a class="source" href="parser.html">
                parser.coffee
              </a>
            
              
              <a class="source" href="vocabulary.html">
                vocabulary.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>compiler.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p><code>compiler.coffee</code> transforms an AST into JavaScript code.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>parser = require <span class="string">'./parser'</span>
vocabulary = require <span class="string">'./vocabulary'</span>
{inherit, die, assert, all} = require <span class="string">'./helpers'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1>Stage 1: Resolve expr nodes</h1>
<p>For each scope (<code>body</code> node), determine the type of each pronoun (<code>symbol</code>
node) used in it.</p>
<p>A pronoun can be either of two types:</p>
<ul>
<li><p>Type <code>X</code>: data or a niladic function</p>
</li>
<li><p>Type <code>F</code>: a verb, adverb, or conjunction</p>
</li>
</ul>
<p>This information is then used to convert each sequence (<code>expr</code> node) into
a hierarchy of function applications.</p>
<p>For instance, after this stage, the APL program <code>(1 + 2) × 3 4</code> will be
represented as:</p>
<pre><code>[&#39;body&#39;,
  [&#39;dyadic&#39;,
    [&#39;dyadic&#39;,
      [&#39;number&#39;, &#39;1&#39;],
      [&#39;symbol&#39;, &#39;+&#39;],
      [&#39;number&#39;, &#39;2&#39;]],
    [&#39;symbol&#39;, &#39;+&#39;],
    [&#39;vector&#39;,
      [&#39;number&#39;, &#39;3&#39;],
      [&#39;number&#39;, &#39;4&#39;]]]]</code></pre>
<p>You can see a textual representation of this tree in your shell, if you
type <code>apl -n filename.apl</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">resolveExprs</span></span> = (ast, opts = {}) -&gt;
  ast.vars =
    <span class="string">'⍺'</span>: {type: <span class="string">'X'</span>, jsCode: <span class="string">'_a'</span>}
    <span class="string">'⍵'</span>: {type: <span class="string">'X'</span>, jsCode: <span class="string">'_w'</span>}
    <span class="string">'∇'</span>: {type: <span class="string">'F'</span>, jsCode: <span class="string">'arguments.callee'</span>}
  <span class="keyword">for</span> k, v <span class="keyword">of</span> vocabulary
    ast.vars[k] = varInfo = {type: <span class="string">'X'</span>, jsCode: <span class="string">"_[<span class="subst">#{JSON.stringify k}</span>]"</span>}
    <span class="keyword">if</span> <span class="keyword">typeof</span> v <span class="keyword">is</span> <span class="string">'function'</span>
      varInfo.type = <span class="string">'F'</span>
      <span class="keyword">if</span> (m = v.aplMetaInfo)?
        <span class="keyword">if</span> m.isPrefixAdverb  <span class="keyword">then</span> varInfo.isPrefixAdverb  = <span class="literal">true</span>
        <span class="keyword">if</span> m.isPostfixAdverb <span class="keyword">then</span> varInfo.isPostfixAdverb = <span class="literal">true</span>
        <span class="keyword">if</span> m.isConjunction   <span class="keyword">then</span> varInfo.isConjunction   = <span class="literal">true</span>
      <span class="keyword">if</span> <span class="regexp">/^[gs]et_.*/</span>.test k
        ast.vars[k[<span class="number">4.</span>..]] = {type: <span class="string">'X'</span>}
  <span class="keyword">if</span> opts.vars
    <span class="keyword">for</span> v <span class="keyword">in</span> opts.vars
      ast.vars[v.name] = {type: <span class="string">'X'</span>, jsCode: v.name}
  scopeCounter = <span class="number">0</span>
  ast.scopeId = scopeCounter++
  queue = [ast] <span class="comment"># accumulates "body" nodes which we encounter on our way</span>
  <span class="keyword">while</span> queue.length
    {vars} = scopeNode = queue.shift()

    <span class="function"><span class="title">visit</span></span> = (node) -&gt;
      node.scopeNode = scopeNode
      <span class="keyword">switch</span> node[<span class="number">0</span>]
        <span class="keyword">when</span> <span class="string">'body'</span>
          node.vars = inherit vars
          node.scopeId = scopeCounter++
          queue.push node
          <span class="literal">null</span>
        <span class="keyword">when</span> <span class="string">'guard'</span>
          visit node[<span class="number">1</span>]
          visit node[<span class="number">2</span>]
        <span class="keyword">when</span> <span class="string">'assign'</span>
          <span class="keyword">if</span> <span class="keyword">not</span> (node[<span class="number">1</span>] <span class="keyword">instanceof</span> Array <span class="keyword">and</span> node[<span class="number">1</span>][<span class="number">0</span>] <span class="keyword">is</span> <span class="string">'symbol'</span>)
            compilerError node, opts, <span class="string">'Compound assignment is not supported.'</span>
          name = node[<span class="number">1</span>][<span class="number">1</span>]
          assert <span class="keyword">typeof</span> name <span class="keyword">is</span> <span class="string">'string'</span>
          h = visit node[<span class="number">2</span>]
          <span class="keyword">if</span> vars[name]
            <span class="keyword">if</span> vars[name].type <span class="keyword">isnt</span> h.type
              compilerError node, opts,
                <span class="string">"Inconsistent usage of symbol '<span class="subst">#{name}</span>', it is "</span> +
                <span class="string">"assigned both data and functions."</span>
          <span class="keyword">else</span>
            vars[name] =
              type: h.type
              jsCode: <span class="string">"_<span class="subst">#{scopeNode.scopeId}</span>[<span class="subst">#{JSON.stringify name}</span>]"</span>
          h
        <span class="keyword">when</span> <span class="string">'symbol'</span>
          name = node[<span class="number">1</span>]
          <span class="keyword">if</span> (v = vars[<span class="string">"get_<span class="subst">#{name}</span>"</span>])?.type <span class="keyword">is</span> <span class="string">'F'</span>
            v.used = <span class="literal">true</span>
            {type: <span class="string">'X'</span>}
          <span class="keyword">else</span>
            v = vars[name]
            <span class="keyword">if</span> <span class="keyword">not</span> v
              compilerError node, opts,
                <span class="string">"Symbol '<span class="subst">#{name}</span>' is referenced before assignment."</span>
            v.used = <span class="literal">true</span>
            v
        <span class="keyword">when</span> <span class="string">'lambda'</span>
          visit node[<span class="number">1</span>]
          {type: <span class="string">'F'</span>}
        <span class="keyword">when</span> <span class="string">'string'</span>, <span class="string">'number'</span>, <span class="string">'embedded'</span>
          {type: <span class="string">'X'</span>}
        <span class="keyword">when</span> <span class="string">'index'</span>
          t1 = visit node[<span class="number">1</span>]
          <span class="keyword">for</span> c <span class="keyword">in</span> node[<span class="number">2.</span>..] <span class="keyword">when</span> c <span class="keyword">isnt</span> <span class="literal">null</span>
            t = visit c
            <span class="keyword">if</span> t.type <span class="keyword">isnt</span> <span class="string">'X'</span>
              compilerError node, opts,
                <span class="string">'Only expressions of type data can be used as an index.'</span>
          t1
        <span class="keyword">when</span> <span class="string">'expr'</span>
          a = node[<span class="number">1.</span>..]
          h = Array a.length
          <span class="keyword">for</span> i <span class="keyword">in</span> [a.length - <span class="number">1</span> .. <span class="number">0</span>]
            h[i] = visit a[i]</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Form vectors from sequences of data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          i = <span class="number">0</span>
          <span class="keyword">while</span> i &lt; a.length - <span class="number">1</span>
            <span class="keyword">if</span> h[i].type <span class="keyword">is</span> h[i + <span class="number">1</span>].type <span class="keyword">is</span> <span class="string">'X'</span>
              j = i + <span class="number">2</span>
              <span class="keyword">while</span> j &lt; a.length <span class="keyword">and</span> h[j].type <span class="keyword">is</span> <span class="string">'X'</span> <span class="keyword">then</span> j++
              a[i...j] = [[<span class="string">'vector'</span>].concat a[i...j]]
              h[i...j] = [{type: <span class="string">'X'</span>}]
            <span class="keyword">else</span>
              i++</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Apply conjunctions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          i = a.length - <span class="number">2</span>
          <span class="keyword">while</span> --i &gt;= <span class="number">0</span>
            <span class="keyword">if</span> (h[i + <span class="number">1</span>].isConjunction <span class="keyword">and</span>
                (h[i].type <span class="keyword">is</span> <span class="string">'F'</span> <span class="keyword">or</span> h[i + <span class="number">2</span>].type <span class="keyword">is</span> <span class="string">'F'</span>))
              a[i...i+<span class="number">3</span>] = [[<span class="string">'conjunction'</span>].concat a[i...i+<span class="number">3</span>]]
              h[i...i+<span class="number">3</span>] = [{type: <span class="string">'F'</span>}]
              i--</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Apply postfix adverbs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          i = <span class="number">0</span>
          <span class="keyword">while</span> i &lt; a.length - <span class="number">1</span>
            <span class="keyword">if</span> h[i].type <span class="keyword">is</span> <span class="string">'F'</span> <span class="keyword">and</span> h[i + <span class="number">1</span>].isPostfixAdverb
              a[i...i+<span class="number">2</span>] = [[<span class="string">'postfixAdverb'</span>].concat a[i...i+<span class="number">2</span>]]
              h[i...i+<span class="number">2</span>] = [{type: <span class="string">'F'</span>}]
            <span class="keyword">else</span>
              i++</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Apply prefix adverbs</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          i = a.length - <span class="number">1</span>
          <span class="keyword">while</span> --i &gt;= <span class="number">0</span>
            <span class="keyword">if</span> h[i].isPrefixAdverb <span class="keyword">and</span> h[i + <span class="number">1</span>].type <span class="keyword">is</span> <span class="string">'F'</span>
              a[i...i+<span class="number">2</span>] = [[<span class="string">'prefixAdverb'</span>].concat a[i...i+<span class="number">2</span>]]
              h[i...i+<span class="number">2</span>] = [{type: <span class="string">'F'</span>}]</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Hooks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span> h.length <span class="keyword">is</span> <span class="number">2</span> <span class="keyword">and</span> h[<span class="number">0</span>].type <span class="keyword">is</span> h[<span class="number">1</span>].type <span class="keyword">is</span> <span class="string">'F'</span>
            a = [[<span class="string">'hook'</span>].concat a]
            h = [{type: <span class="string">'F'</span>}]</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Forks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="keyword">if</span> (h.length &gt;= <span class="number">3</span> <span class="keyword">and</span> h.length % <span class="number">2</span> <span class="keyword">is</span> <span class="number">1</span> <span class="keyword">and</span>
                  all(<span class="keyword">for</span> x <span class="keyword">in</span> h <span class="keyword">then</span> x.type <span class="keyword">is</span> <span class="string">'F'</span>))
            a = [[<span class="string">'fork'</span>].concat a]
            h = [{type: <span class="string">'F'</span>}]

          <span class="keyword">if</span> h[h.length - <span class="number">1</span>].type <span class="keyword">is</span> <span class="string">'F'</span>
            <span class="keyword">if</span> h.length &gt; <span class="number">1</span>
              compilerError a[h.length - <span class="number">1</span>], opts,
                <span class="string">'Trailing function in expression'</span>
          <span class="keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Apply monadic and dyadic functions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="keyword">while</span> h.length &gt; <span class="number">1</span>
              <span class="keyword">if</span> h.length <span class="keyword">is</span> <span class="number">2</span> <span class="keyword">or</span> h[h.length - <span class="number">3</span>].type <span class="keyword">is</span> <span class="string">'F'</span>
                a[h.length - <span class="number">2.</span>..] = [[<span class="string">'monadic'</span>].concat a[h.length - <span class="number">2.</span>..]]
                h[h.length - <span class="number">2.</span>..] = [{type: <span class="string">'X'</span>}]
              <span class="keyword">else</span>
                a[h.length - <span class="number">3.</span>..] = [[<span class="string">'dyadic'</span>].concat a[h.length - <span class="number">3.</span>..]]
                h[h.length - <span class="number">3.</span>..] = [{type: <span class="string">'X'</span>}]</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Replace <code>&quot;expr&quot;</code> node with <code>a[0]</code> in the AST</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          node[<span class="number">0.</span>..] = a[<span class="number">0</span>]
          h[<span class="number">0</span>]

        <span class="keyword">else</span>
          die <span class="string">"Unrecognised node type, '<span class="subst">#{node[<span class="number">0</span>]}</span>'"</span>

    <span class="keyword">for</span> node <span class="keyword">in</span> scopeNode[<span class="number">1.</span>..]
      visit node

  <span class="keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <h1>Stage 2: Render JavaScript code</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">toJavaScript</span></span> = (node) -&gt;
  <span class="keyword">switch</span> node[<span class="number">0</span>]

    <span class="keyword">when</span> <span class="string">'body'</span>
      <span class="keyword">if</span> node.length <span class="keyword">is</span> <span class="number">1</span>
        <span class="string">'return [];\n'</span>
      <span class="keyword">else</span>
        a = [<span class="string">"var _<span class="subst">#{node.scopeId}</span> = {};\n"</span>]
        <span class="keyword">for</span> child <span class="keyword">in</span> node[<span class="number">1.</span>..] <span class="keyword">then</span> a.push toJavaScript child
        a[a.length - <span class="number">1</span>] = <span class="string">"return <span class="subst">#{a[a.length - <span class="number">1</span>]}</span>;\n"</span>
        a.join(<span class="string">';\n'</span>)

    <span class="keyword">when</span> <span class="string">'guard'</span>
      <span class="string">"""
        if (_['⎕bool'](<span class="subst">#{toJavaScript node[<span class="number">1</span>]}</span>)) {
          return <span class="subst">#{toJavaScript node[<span class="number">2</span>]}</span>;
        }
      """</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Assignment</p>
<pre><code>A←5       ⍝ returns 5
A×A←2 5   ⍝ returns 4 25</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">when</span> <span class="string">'assign'</span>
      <span class="keyword">if</span> <span class="keyword">not</span> (node[<span class="number">1</span>] <span class="keyword">instanceof</span> Array <span class="keyword">and</span>
              node[<span class="number">1</span>].length <span class="keyword">is</span> <span class="number">2</span> <span class="keyword">and</span>
              node[<span class="number">1</span>][<span class="number">0</span>] <span class="keyword">is</span> <span class="string">'symbol'</span>)
        compilerError node, opts,
          <span class="string">'Compound assignment is not supported.'</span>
      name = node[<span class="number">1</span>][<span class="number">1</span>]
      assert <span class="keyword">typeof</span> name <span class="keyword">is</span> <span class="string">'string'</span>
      <span class="keyword">if</span> name <span class="keyword">is</span> <span class="string">'∇'</span>
        compilerError node, opts,
          <span class="string">'Assignment to ∇ is not allowed.'</span>
      vars = node.scopeNode.vars
      <span class="keyword">if</span> (v = vars[<span class="string">"set_<span class="subst">#{name}</span>"</span>])?.type <span class="keyword">is</span> <span class="string">'F'</span>
        v.used = <span class="literal">true</span>
        <span class="string">"<span class="subst">#{v.jsCode}</span>(<span class="subst">#{toJavaScript node[<span class="number">2</span>]}</span>)"</span> <span class="comment"># todo: pass-through value</span>
      <span class="keyword">else</span>
        <span class="string">"<span class="subst">#{vars[name].jsCode}</span> = <span class="subst">#{toJavaScript node[<span class="number">2</span>]}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Symbols</p>
<p>Test get<em>/set</em> convention for niladics:</p>
<pre><code>radius ← 3
... get_circumference ← {2 × ○ radius}
... get_surface ← {○ radius ⋆ 2}
...
... before ← 0.01× ⌊ 100× radius circumference surface
... radius ← radius + 1
... after  ← 0.01× ⌊ 100× radius circumference surface
...
... before after
... ⍝ returns (3 18.84 28.27) (4 25.13 50.26)</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">when</span> <span class="string">'symbol'</span>
      name = node[<span class="number">1</span>]
      vars = node.scopeNode.vars
      <span class="keyword">if</span> (v = vars[<span class="string">"get_<span class="subst">#{name}</span>"</span>])?.type <span class="keyword">is</span> <span class="string">'F'</span>
        v.used = <span class="literal">true</span>
        <span class="string">"<span class="subst">#{v.jsCode}</span>()"</span>
      <span class="keyword">else</span>
        v = vars[name]
        v.used = <span class="literal">true</span>
        v.jsCode</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Lambda expressions</p>
<pre><code>{1 + 1} 1                      ⍝ returns 2
{⍵=0:1 ◇ 2×∇⍵−1} 5             ⍝ returns 32 # two to the power of
{⍵&lt;2 : 1 ◇ (∇⍵−1)+(∇⍵−2) } 8   ⍝ returns 34 # Fibonacci sequence</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">when</span> <span class="string">'lambda'</span>
      <span class="string">"""
        function (_w, _a) {
          <span class="subst">#{toJavaScript node[<span class="number">1</span>]}</span>
        }
      """</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Strings of length one are scalars, all other strings are vectors.</p>
<pre><code>⍴⍴&#39;&#39;     ⍝ returns ,1
⍴⍴&#39;x&#39;    ⍝ returns ,0
⍴⍴&#39;xx&#39;   ⍝ returns ,1</code></pre>
<p>Pairs of quotes inside strings:</p>
<pre><code>&#39;Let&#39;&#39;s parse it!&#39;         ⍝ returns &#39;Let\&#39;s parse it!&#39;
&quot;0x22&#39;s the code for &quot;&quot;.&quot;  ⍝ returns &#39;0x22\&#39;s the code for &quot;.&#39;
⍴&quot;\f\t\n\r\u1234\xff&quot;      ⍝ returns ,6

&quot;unclosed string           ⍝ fails</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">when</span> <span class="string">'string'</span>
      s = node[<span class="number">1</span>]
      d = s[<span class="number">0</span>] <span class="comment"># the delimiter: '"' or "'"</span>
      <span class="string">"_['⎕aplify'](<span class="subst">#{d + s[<span class="number">1.</span>..-<span class="number">1</span>].replace(///#{d + d}</span>///g, '\\' + d) + d})"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Numbers</p>
<pre><code>1234567890  ⍝ returns «1234567890»
12.34e56    ⍝ returns «12.34e56»
12.34e+56   ⍝ returns «12.34e+56»
12.34E56    ⍝ returns «12.34e56»
¯12.34e¯56  ⍝ returns «-12.34e-56»
0Xffff      ⍝ returns «0xffff»
¯0xffff     ⍝ returns «-0xffff»
¯0xaBcD1234 ⍝ returns «-0xabcd1234»
¯           ⍝ returns «Infinity»
¯¯          ⍝ returns «-Infinity»
−¯          ⍝ returns «-Infinity»</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">when</span> <span class="string">'number'</span>
      s = node[<span class="number">1</span>].replace <span class="regexp">/¯/g</span>, <span class="string">'-'</span>
      a =
        <span class="keyword">for</span> x <span class="keyword">in</span> s.split <span class="regexp">/j/i</span>
          <span class="keyword">if</span> x <span class="keyword">is</span> <span class="string">'-'</span>
            <span class="string">'Infinity'</span>
          <span class="keyword">else</span> <span class="keyword">if</span> x <span class="keyword">is</span> <span class="string">'--'</span>
            <span class="string">'-Infinity'</span>
          <span class="keyword">else</span> <span class="keyword">if</span> x.match <span class="regexp">/^-?0x/i</span>
            parseInt x, <span class="number">16</span>
          <span class="keyword">else</span>
            parseFloat x
      <span class="keyword">if</span> a.length <span class="keyword">is</span> <span class="number">1</span> <span class="keyword">or</span> a[<span class="number">1</span>] <span class="keyword">is</span> <span class="number">0</span> <span class="keyword">then</span> <span class="string">''</span> + a[<span class="number">0</span>]
      <span class="keyword">else</span> <span class="string">"new _['⎕complex'](<span class="subst">#{a[<span class="number">0</span>]}</span>, <span class="subst">#{a[<span class="number">1</span>]}</span>)"</span>

    <span class="keyword">when</span> <span class="string">'index'</span>
      <span class="string">"_['⌷'](<span class="subst">#{toJavaScript node[<span class="number">1</span>]}</span>, [<span class="subst">#{
        (<span class="keyword">for</span> c <span class="keyword">in</span> node[<span class="number">2.</span>..] <span class="keyword">when</span> c <span class="keyword">isnt</span> <span class="literal">null</span> <span class="keyword">then</span> toJavaScript c).join ', '
      }</span>], [<span class="subst">#{
        (<span class="keyword">for</span> c, i <span class="keyword">in</span> node[<span class="number">2.</span>..] <span class="keyword">when</span> c <span class="keyword">isnt</span> <span class="literal">null</span> <span class="keyword">then</span> i)
      }</span>])"</span>

    <span class="keyword">when</span> <span class="string">'expr'</span>
      die <span class="string">'No "expr" nodes are expected at this stage.'</span>

    <span class="keyword">when</span> <span class="string">'vector'</span>
      n = node.length - <span class="number">1</span>
      <span class="string">"[<span class="subst">#{(<span class="keyword">for</span> child <span class="keyword">in</span> node[<span class="number">1.</span>..] <span class="keyword">then</span> toJavaScript child).join ', '}</span>]"</span>

    <span class="keyword">when</span> <span class="string">'monadic'</span>
      <span class="string">"<span class="subst">#{toJavaScript node[<span class="number">1</span>]}</span>(<span class="subst">#{toJavaScript node[<span class="number">2</span>]}</span>)"</span>

    <span class="keyword">when</span> <span class="string">'dyadic'</span>
      <span class="string">"<span class="subst">#{toJavaScript node[<span class="number">2</span>]}</span>(<span class="subst">#{toJavaScript node[<span class="number">3</span>]}</span>, <span class="subst">#{toJavaScript node[<span class="number">1</span>]}</span>)"</span>

    <span class="keyword">when</span> <span class="string">'prefixAdverb'</span>
      <span class="string">"<span class="subst">#{toJavaScript node[<span class="number">1</span>]}</span>(<span class="subst">#{toJavaScript node[<span class="number">2</span>]}</span>)"</span>

    <span class="keyword">when</span> <span class="string">'conjunction'</span>
      <span class="string">"<span class="subst">#{toJavaScript node[<span class="number">2</span>]}</span>(<span class="subst">#{toJavaScript node[<span class="number">3</span>]}</span>, <span class="subst">#{toJavaScript node[<span class="number">1</span>]}</span>)"</span>

    <span class="keyword">when</span> <span class="string">'postfixAdverb'</span>
      <span class="string">"<span class="subst">#{toJavaScript node[<span class="number">2</span>]}</span>(<span class="subst">#{toJavaScript node[<span class="number">1</span>]}</span>)"</span>

    <span class="keyword">when</span> <span class="string">'hook'</span>
      <span class="string">"_['⎕hook'](<span class="subst">#{toJavaScript node[<span class="number">2</span>]}</span>, <span class="subst">#{toJavaScript node[<span class="number">1</span>]}</span>)"</span>

    <span class="keyword">when</span> <span class="string">'fork'</span>
      <span class="string">"_['⎕fork']([<span class="subst">#{<span class="keyword">for</span> c <span class="keyword">in</span> node[<span class="number">1.</span>..] <span class="keyword">then</span> toJavaScript c}</span>])"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Embedded JavaScript</p>
<pre><code>«1234+5678» ⍝ returns 6912
«&quot;asdf&quot;» ⍝ returns &#39;asdf&#39;</code></pre>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">when</span> <span class="string">'embedded'</span>
      <span class="string">"_['⎕aplify'](<span class="subst">#{node[<span class="number">1</span>].replace /(^«|»$)/g, ''}</span>)"</span>

    <span class="keyword">else</span>
      die <span class="string">"Unrecognised node type, '<span class="subst">#{node[<span class="number">0</span>]}</span>'"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Used to report the AST node where the error happened</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">compilerError</span></span> = (node, opts, message) -&gt;
  die message,
    name: <span class="string">'APLCompilerError'</span>
    file: opts.file
    line: node.startLine
    col: node.startCol
    aplCode: opts.aplCode</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <h1>Public interface to this module</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="property">@nodes</span> = <span class="function"><span class="title">nodes</span></span> = (aplCode, opts = {}) -&gt;
  opts.aplCode = aplCode
  ast = parser.parse aplCode, opts
  resolveExprs ast, opts
  ast

<span class="property">@compile</span> = <span class="function"><span class="title">compile</span></span> = (aplCode, opts = {}) -&gt;
  opts.aplCode = aplCode
  jsCode = toJavaScript nodes aplCode, opts
  <span class="keyword">if</span> opts.embedded
    jsCode = <span class="string">"""
      var _ = require('apl').createGlobalContext(),
          _a = arguments[0],
          _w = arguments[1];
      <span class="subst">#{jsCode}</span>
    """</span>
  jsCode


<span class="property">@exec</span> = (aplCode, opts = {}) -&gt;
  opts.aplCode = aplCode
  (<span class="keyword">new</span> Function <span class="string">"""
    var _ = arguments[0];
    <span class="subst">#{compile aplCode, opts}</span>
  """</span>) inherit vocabulary, opts.extraContext</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
