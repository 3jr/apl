<!DOCTYPE html>

<html>
<head>
  <title>command.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="apl.html">
                apl.coffee
              </a>
            
              
              <a class="source" href="command.html">
                command.coffee
              </a>
            
              
              <a class="source" href="compiler.html">
                compiler.coffee
              </a>
            
              
              <a class="source" href="complex.html">
                complex.coffee
              </a>
            
              
              <a class="source" href="formatter.html">
                formatter.coffee
              </a>
            
              
              <a class="source" href="helpers.html">
                helpers.coffee
              </a>
            
              
              <a class="source" href="lexer.html">
                lexer.coffee
              </a>
            
              
              <a class="source" href="parser.html">
                parser.coffee
              </a>
            
              
              <a class="source" href="vocabulary.html">
                vocabulary.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>command.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p><code>command.coffee</code> contains the <code>main()</code> entry point to the APL compiler when
invoked as a shell command.</p>
<p>Our command-line interface closely follows the design of
<a href="http://coffeescript.org/#usage">that of CoffeeScript</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>optimist = require <span class="string">'optimist'</span>
fs = require <span class="string">'fs'</span>
{nodes, compile, exec} = require <span class="string">'./compiler'</span>

<span class="property">@main</span> = -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>We use <a href="https://github.com/substack/node-optimist#readme">optimist</a> to
parse the arguments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  {argv} = optimist
    .usage('''
      Usage: apl [options] path/to/script.apl [args]\n
      If called without options, `apl` will run your script.
    ''')
    .describe
      c: 'compile to JavaScript and save as .js files'
      h: 'display this help message'
      i: 'run an interactive APL REPL'
      n: 'print out the parse tree that the parser produces'
      p: 'print out the compiled JavaScript'
      s: 'listen for and compile scripts over stdio'
    .alias
      c: 'compile'
      h: 'help'
      i: 'interactive'
      n: 'nodes'
      p: 'print'
      s: 'stdio'
    .boolean('chinps'.split '')</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Show help, if requested.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> argv.help <span class="keyword">then</span> <span class="keyword">return</span> optimist.showHelp()</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Complain about unknown or incompatible options.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  knownOptions =
    'c compile h help i interactive n nodes p print s stdio _'.split ' '
  for k of argv when (k not in knownOptions) and not k.match /^\$\d+/
    process.stderr.write "Unknown option, \"#{k}\"\n\n"
    optimist.showHelp()
    return

  if (argv.interactive and
        (argv.compile or argv.nodes or argv.print or argv.stdio))
    process.stderr.write '''
      Option -i (--interactive) is incompatible with the following options:
        -c, --compile
        -n, --nodes
        -p, --print
        -s, --stdio\n\n
    '''
    optimist.showHelp()
    return

  if argv.interactive and argv._.length
    process.stderr.write '''
      Option -i (--interactive) cannot be used with positional arguments.\n\n
    '''
    optimist.showHelp()
    return</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Prepare for compilation/execution, create a context object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ctx =
    <span class="string">'‚çµ'</span>: <span class="keyword">for</span> a <span class="keyword">in</span> argv._ <span class="keyword">then</span> a.split <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Start a REPL if requested or if no input is specified.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> argv.interactive <span class="keyword">or</span> <span class="keyword">not</span> (argv._.length <span class="keyword">or</span> argv.stdio)
    <span class="keyword">return</span> repl ctx</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Determine input.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  opts = {}
  <span class="keyword">if</span> argv.stdio
    opts.file = <span class="string">'&lt;stdin&gt;'</span>
    aplCode =
      Buffer.concat(<span class="keyword">loop</span> <span class="comment"># read all of stdin</span>
        b = <span class="keyword">new</span> Buffer <span class="number">1024</span>
        k = fs.readSync <span class="number">0</span>, b, <span class="number">0</span>, b.length, <span class="literal">null</span>
        <span class="keyword">break</span> <span class="keyword">unless</span> k
        b.slice <span class="number">0</span>, k
      ).toString <span class="string">'utf8'</span>
  <span class="keyword">else</span>
    opts.file = argv._[<span class="number">0</span>]
    isCoffeeScript = <span class="regexp">/\.coffee$/</span>.test opts.file
    aplCode = fs.readFileSync opts.file, <span class="string">'utf8'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>If printing of nodes is requested, do it and stop.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> argv.nodes
    printAST nodes aplCode, opts
    <span class="keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Compile.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> isCoffeeScript
    cs = require <span class="string">'coffee-script'</span>
    pp = require <span class="string">'coffee-subscript'</span>
    jsCode = cs.compile pp.preprocess aplCode, opts
  <span class="keyword">else</span>
    jsCode = compile aplCode, opts</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Print or execute compiler output</p>
<p>(it looks a little hairy because we must wrap compiler output differently
depending on where it will be executed, but really it&#39;s straightforward)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> argv.compile
    <span class="keyword">if</span> isCoffeeScript
      jsCode = <span class="string">"""
        \#!/usr/bin/env node
        <span class="subst">#{jsCode}</span>
      """</span>
    <span class="keyword">else</span>
      jsCode = <span class="string">"""
        \#!/usr/bin/env node
        var _ = require('apl').createGlobalContext();
        <span class="subst">#{jsCode}</span>
      """</span>
    <span class="keyword">if</span> argv.stdio <span class="keyword">or</span> argv.print
      process.stdout.write jsCode
    <span class="keyword">else</span>
      filename = argv._[<span class="number">0</span>].replace(<span class="regexp">/\.(apl|coffee)$/</span>, <span class="string">'.js'</span>)
      fs.writeFileSync filename, jsCode, <span class="string">'utf8'</span>
  <span class="keyword">else</span>
    <span class="keyword">if</span> isCoffeeScript
      <span class="function"><span class="title">fakeRequire</span></span> = (args...) -&gt;
        <span class="keyword">if</span> args.length <span class="keyword">is</span> <span class="number">1</span> <span class="keyword">and</span> args[<span class="number">0</span>] <span class="keyword">is</span> <span class="string">'apl'</span>
          require <span class="string">'./apl'</span>
        <span class="keyword">else</span>
          require args...
      (<span class="keyword">new</span> Function <span class="string">"""
        var require = arguments[0];
        <span class="subst">#{jsCode}</span>
      """</span>) fakeRequire
    <span class="keyword">else</span>
      (<span class="keyword">new</span> Function <span class="string">"""
        var _ = arguments[0];
        <span class="subst">#{jsCode}</span>
      """</span>) require(<span class="string">'./apl'</span>).createGlobalContext()</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Read-eval-print loop</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">repl</span></span> = (ctx) -&gt;
  readline = require <span class="string">'readline'</span>
  rl = readline.createInterface process.stdin, process.stdout
  rl.setPrompt <span class="string">'APL&gt; '</span>

  {format} = require(<span class="string">'./formatter'</span>)
  rl.<span class="literal">on</span> <span class="string">'line'</span>, (line) -&gt;
    <span class="keyword">try</span>
      <span class="keyword">if</span> <span class="keyword">not</span> line.match <span class="regexp">/^[\ \t\f\r\n]*$/</span>
        result = exec line, extraContext: ctx
        process.stdout.write format(result).join(<span class="string">'\n'</span>) + <span class="string">'\n'</span>
    <span class="keyword">catch</span> e
      console.error e
    rl.prompt()
    <span class="keyword">return</span>

  rl.<span class="literal">on</span> <span class="string">'close'</span>, -&gt;
    process.stdout.write <span class="string">'\n'</span>
    process.exit <span class="number">0</span>
    <span class="keyword">return</span>

  rl.prompt()
  <span class="keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Helper functions for printing AST nodes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">printAST</span></span> = (x, indent = <span class="string">''</span>) -&gt;
  <span class="keyword">if</span> isArray x
    <span class="keyword">if</span> x.length <span class="keyword">is</span> <span class="number">2</span> <span class="keyword">and</span> <span class="keyword">not</span> isArray x[<span class="number">1</span>]
      console.info indent + x[<span class="number">0</span>] + <span class="string">' '</span> + JSON.stringify x[<span class="number">1</span>]
    <span class="keyword">else</span>
      console.info indent + x[<span class="number">0</span>]
      <span class="keyword">for</span> y <span class="keyword">in</span> x[<span class="number">1.</span>..]
        printAST y, indent + <span class="string">'  '</span>
  <span class="keyword">else</span>
    console.info indent + JSON.stringify x
  <span class="keyword">return</span>

<span class="function"><span class="title">isArray</span></span> = (x) -&gt; x?.length? <span class="keyword">and</span> <span class="keyword">typeof</span> x <span class="keyword">isnt</span> <span class="string">'string'</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
