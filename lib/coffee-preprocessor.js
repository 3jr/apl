// Generated by CoffeeScript 1.4.0
var define;

if (typeof define !== 'function') {
  define = require('amdefine')(module);
}

define(function() {
  var compile;
  compile = require('./compiler').compile;
  return {
    preprocess: function(code, ctx) {
      var fragment, i, indent, indentRE, j, lines, _ref;
      code = code.replace(/«([^»]*)»/g, function(_1, fragment) {
        return "`(require('apl')(function () {" + (compile(fragment, {
          extraContext: ctx
        }).jsOutput) + "}))`";
      });
      lines = code.split('\n');
      i = 0;
      while (i < lines.length) {
        if (/~>$/.test(lines[i])) {
          indent = lines[i].replace(/^([ \t]*).*$/, '$1');
          indentRE = new RegExp('^' + indent.replace(/\t/g, '\\t') + '[ \\t]');
          j = i + 1;
          while (j < lines.length && (/^[ \t]*([#⍝].*)?$/.test(lines[j]) || indentRE.test(lines[j]))) {
            j++;
          }
          fragment = lines.slice(i + 1, j).join('\n');
          [].splice.apply(lines, [i, j - i].concat(_ref = [
            lines[i].replace(/~>$/, "`(function () {          " + (compile(fragment, {
              extraContext: ctx
            }).jsOutput) + "        })`")
          ])), _ref;
        }
        i++;
      }
      return lines.join('\n');
    }
  };
});
