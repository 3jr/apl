// Generated by CoffeeScript 1.4.0
var define;

if (typeof define !== 'function') {
  define = require('amdefine')(module);
}

define(function() {
  var compile, inherit;
  compile = require('./compiler').compile;
  inherit = require('./helpers').inherit;
  return {
    preprocess: function(coffeeCode) {
      var ast, fragments, i, indent, indentRE, j, lines, queue, scopeNode, _ref;
      fragments = [];
      coffeeCode = coffeeCode.replace(/«([^»]*)»/g, function(_1, aplCode) {
        fragments.push({
          kind: 'expression',
          aplCode: aplCode
        });
        return "`@" + (fragments.length - 1) + "`";
      });
      lines = coffeeCode.split('\n');
      i = 0;
      while (i < lines.length) {
        if (/~>$/.test(lines[i])) {
          indent = lines[i].replace(/^([ \t]*).*$/, '$1');
          indentRE = new RegExp('^' + indent.replace(/\t/g, '\\t') + '[ \\t]');
          j = i + 1;
          while (j < lines.length && (/^[ \t]*([#⍝].*)?$/.test(lines[j]) || indentRE.test(lines[j]))) {
            j++;
          }
          fragments.push({
            kind: 'function',
            aplCode: lines.slice(i + 1, j).join('\n')
          });
          [].splice.apply(lines, [i, j - i].concat(_ref = [lines[i].replace(/~>$/, "`@" + (fragments.length - 1) + "`")])), _ref;
        }
        i++;
      }
      coffeeCode = lines.join('\n');
      ast = require('coffee-script').nodes(coffeeCode);
      ast.vars = {};
      queue = [ast];
      while (queue.length) {
        scopeNode = queue.shift();
        scopeNode.traverseChildren(false, function(node) {
          var m, name, v, _ref1, _ref2;
          name = node.constructor.name;
          if (name === 'Code') {
            node.vars = inherit(scopeNode.vars);
            queue.push(node);
          } else if (name === 'Literal' && (m = node.value.match(/^@(\d+)$/))) {
            fragments[+m[1]].vars = scopeNode.vars;
          } else if (name === 'Assign') {
            if (v = (_ref1 = node.variable) != null ? (_ref2 = _ref1.base) != null ? _ref2.value : void 0 : void 0) {
              scopeNode.vars[v] = {
                type: 'X',
                jsCode: v
              };
            }
          }
          return true;
        });
      }
      return coffeeCode.replace(/`@(\d+)`/g, function(_1, id) {
        var f, jsCode;
        f = fragments[+id];
        jsCode = "(function () {\n  var _ = require('apl').createGlobalContext();\n  " + (compile(f.aplCode, {
          extraVars: f.vars
        })) + "\n})";
        if (f.kind === 'expression') {
          jsCode += '()';
        }
        return "`" + jsCode + "`";
      });
    }
  };
});
